<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>neuropy.frequentist_statistics &#8212; neuropy v1.5.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">

                <li><a href="../../index.html">Home</a></li>


              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html"><code class="docutils literal notranslate"><span class="pre">neuropy.anomaly_detection</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.cluster_analysis"><code class="docutils literal notranslate"><span class="pre">neuropy.cluster_analysis</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.config"><code class="docutils literal notranslate"><span class="pre">neuropy.config</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.correlation"><code class="docutils literal notranslate"><span class="pre">neuropy.correlation</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.dimensionality_reduction"><code class="docutils literal notranslate"><span class="pre">neuropy.dimensionality_reduction</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.frequency_domain"><code class="docutils literal notranslate"><span class="pre">neuropy.frequency_domain</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.frequentist_statistics"><code class="docutils literal notranslate"><span class="pre">neuropy.frequentist_statistics</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.group_analysis"><code class="docutils literal notranslate"><span class="pre">neuropy.group_analysis</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.internal_composite"><code class="docutils literal notranslate"><span class="pre">neuropy.internal_composite</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.internal_utils"><code class="docutils literal notranslate"><span class="pre">neuropy.internal_utils</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.machine_learning_classification"><code class="docutils literal notranslate"><span class="pre">neuropy.machine_learning_classification</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.machine_learning_regression"><code class="docutils literal notranslate"><span class="pre">neuropy.machine_learning_regression</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.machine_learning_utils"><code class="docutils literal notranslate"><span class="pre">neuropy.machine_learning_utils</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.utils"><code class="docutils literal notranslate"><span class="pre">neuropy.utils</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.vumc_utils"><code class="docutils literal notranslate"><span class="pre">neuropy.vumc_utils</span></code></a></li>
</ul>
</ul>
</li>

                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>






          </ul>



<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">

  <h1>Source code for neuropy.frequentist_statistics</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Submodule frequentist_statistics.py includes the following functions: &lt;br&gt;</span>
<span class="sd">   - **chisquare():** Run chi-square test using `stats.chi2_contingency` &lt;br&gt;</span>
<span class="sd">   - **permutation_plot():** Show the result of the permutations &lt;br&gt;</span>
<span class="sd">   - **permute_test():** Helper function to run tests for permutations &lt;br&gt;</span>
<span class="sd">   - **dependent_t_test():** Run paired sample t-tests including assumptions using `scipy.stats.ttest_rel` &lt;br&gt;</span>
<span class="sd">   - **analysis_dependent_t_test():** Run `dependent_t_test` for all combinations of features &lt;br&gt;</span>
<span class="sd">   - **independent_t_test():** Run independent sample t-tests including assumptions using `scipy.stats.levene` and</span>
<span class="sd">     `statsmodels.stats.weightstats.ttest_ind` &lt;br&gt;</span>
<span class="sd">   - **analysis_independent_t_test():** Run `independent_t_test` for all combinations of features &lt;br&gt;</span>
<span class="sd">   - **dependent_wilcoxon_test():** Run paired sample Wilcoxon test using `scipy.stats.wilcoxon` &lt;br&gt;</span>
<span class="sd">   - **analysis_dependent_wilcoxon_test():** Run `dependent_wilcoxon_test` for all combinations of features &lt;br&gt;</span>
<span class="sd">   - **independent_mannwhitneyu_test():** Run independent Mann-Whitney U test using `scipy.stats.mannwhitneyu` &lt;br&gt;</span>
<span class="sd">   - **analysis_independent_mannwhitneyu_test():** Run `independent_mannwhitneyu_test` for all features &lt;br&gt;</span>
<span class="sd">   - **one_way_ANOVA():** Run one-way ANOVAs using `scipy.stats.f_oneway` and check homogeneity of variances with Levenes</span>
<span class="sd">     test using `scipy.stats.levene` &lt;br&gt;</span>
<span class="sd">   - **mapping_dist_mean_median():** Adds line and text relative to moments of distribution to densityplots using</span>
<span class="sd">     `seaborn.distplots` &lt;br&gt;</span>
<span class="sd">   - **plot_distribution():** Plot distributions relative to numerical (ungrouped) features &lt;br&gt;</span>
<span class="sd">   - **ecdf():** Computes empirical cumulative distribution function for a one-dimensional array of measurements &lt;br&gt;</span>
<span class="sd">   - **mapping_ecdf():** Adds empirical and theoretical distribution of the data &lt;br&gt;</span>
<span class="sd">   - **compare_theoretical_ecdf():** compare empirical distribution to the theoretical distribution based on mean and</span>
<span class="sd">     standard deviation &lt;br&gt;</span>
<span class="sd">   - **normal_check():** compare the distribution of numeric variables to a normal distribution using the Kolmogrov-Smirnov</span>
<span class="sd">     test &lt;br&gt;</span>
<span class="sd">   - **apply_power_transformations():** transform data with log transformations and Box-cox transformations &lt;br&gt;</span>
<span class="sd">   - **find_optimal_transformation():** choose the best transformation based on the results of `normal_check` after</span>
<span class="sd">     `apply_power_transformations` &lt;br&gt;</span>
<span class="sd">   - **ols():** run a linear regression model with ordinary least squares (OLS) estimation &lt;br&gt;</span>
<span class="sd">   - **diagnostic_plots():** function to reproduce the 4 diagnostic plots of an OLS model in R. Currently, fitted linear</span>
<span class="sd">   regression models/ mixed linear models from pymer4, statsmodels, and sklearn are accepted. &lt;br&gt;</span>
<span class="sd">   - **correct_pvalues():** function to correct for multiple testing &lt;br&gt;</span>
<span class="sd">   - **bland_altman_plot():** function to plot a mean-difference plot also know as a Bland-Altman Plot. &lt;br&gt;</span>
<span class="sd">   - **bland_altman_plot_repeated():** an adapted function to plot a mean-difference plot also know as a Bland-Altman Plot,</span>
<span class="sd">   whilst accounting for multiple time points per group. &lt;br&gt;</span>
<span class="sd">   - **ICC_repeated_measures_anova():** function to calculate the ICC based on the repeated measures ANOVA framework. &lt;br&gt;</span>
<span class="sd">   - **multiple_ICCs():** a wrapper function to return the ICC, SDC and SEMc based on repeated measures data. &lt;br&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">np_linalg</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statsmodels</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">statsmodels.stats.weightstats</span> <span class="k">as</span> <span class="nn">smsw</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.gofplots</span> <span class="kn">import</span> <span class="n">ProbPlot</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multitest</span> <span class="kn">import</span> <span class="n">multipletests</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.eval_measures</span> <span class="kn">import</span> <span class="n">rmse</span>

<span class="kn">from</span> <span class="nn">neuropy.utils</span> <span class="kn">import</span> <span class="n">NeurocastColors</span>


<div class="viewcode-block" id="chisquare"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.chisquare">[docs]</a><span class="k">def</span> <span class="nf">chisquare</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run chi-square test using `stats.chi2_contingency`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        Dataframe with variables in columns, cases in rows</span>
<span class="sd">    groups: str</span>
<span class="sd">        column name of groups in `data`</span>
<span class="sd">    categories: str</span>
<span class="sd">        column name of categories in `data`</span>
<span class="sd">    show: bool (default: True)</span>
<span class="sd">        Whether to print the results of the analysis</span>
<span class="sd">    correction: bool (default: True)</span>
<span class="sd">        Whether to apply the Yates’ correction for continuity</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Data frame with columns [&#39;test-type&#39;, &#39;grouping-var&#39;, &#39;categories&#39;, &#39;chi-square&#39;, &#39;df&#39;, &#39;p-value&#39;, &#39;stat-sign&#39;]</span>

<span class="sd">    Examples</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&#39;tips&#39;)</span>
<span class="sd">    &gt;&gt;&gt; chisquare(tips, &#39;smoker&#39;, &#39;sex&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ct</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">groups</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">categories</span><span class="p">])</span>
    <span class="n">chi2</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">degrees_freedom</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2_contingency</span><span class="p">(</span>
        <span class="n">ct</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="n">correction</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;=== Chi-square test: groups = *</span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">* | categories = *</span><span class="si">{</span><span class="n">categories</span><span class="si">}</span><span class="s2">* ===</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chi2 = </span><span class="si">{</span><span class="n">chi2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;df = </span><span class="si">{</span><span class="n">degrees_freedom</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expected frequencies&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Original data&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>

    <span class="c1"># return result on a row data frame</span>
    <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;chisquare&quot;</span><span class="p">,</span>
        <span class="s2">&quot;grouping-var&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="p">,</span>
        <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">categories</span><span class="p">,</span>
        <span class="s2">&quot;chi-square&quot;</span><span class="p">:</span> <span class="n">chi2</span><span class="p">,</span>
        <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">degrees_freedom</span><span class="p">,</span>
        <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
        <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;One of </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">categories</span><span class="si">}</span><span class="s2"> consisted of a single value&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ct</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;At least one observed frequency is &lt; 5 so test should not be used&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expected</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;At least one expected frequency is &lt; 5 so test should not be used&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_result</span></div>


<div class="viewcode-block" id="permutation_plot"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.permutation_plot">[docs]</a><span class="k">def</span> <span class="nf">permutation_plot</span><span class="p">(</span>
    <span class="n">permutations</span><span class="p">,</span> <span class="n">p_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">feature1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">)</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Show the result of the permutations using a histogram</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    permutations: array-like</span>
<span class="sd">        Array with single p-value per permutation</span>
<span class="sd">    p_value: float</span>
<span class="sd">        P-value obtained from real data</span>
<span class="sd">    feature1: None or str (default: None)</span>
<span class="sd">        Name of the first feature involved</span>
<span class="sd">    feature2: None or str (default: None)</span>
<span class="sd">        Name of the second feature involved</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    permutation_plot: Figure</span>

<span class="sd">    Examples</span>
<span class="sd">    ---------</span>

<span class="sd">    Demonstration of the function using random data</span>

<span class="sd">    &gt;&gt;&gt; permutations = np.random.rand(100)</span>
<span class="sd">    &gt;&gt;&gt; permutation_plot = permutation_plot(permutations, p_value = 0.02)</span>
<span class="sd">    &gt;&gt;&gt; # plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">permutation_plot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
        <span class="n">permutations</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p-values from permutations of the data&quot;</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p-value from real data&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Add custom title</span>
    <span class="k">if</span> <span class="n">feature1</span> <span class="ow">and</span> <span class="n">feature2</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permutations </span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">permutation_plot</span></div>


<div class="viewcode-block" id="dependent_t_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.dependent_t_test">[docs]</a><span class="k">def</span> <span class="nf">dependent_t_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">feature2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run paired sample t-tests including assumptions using `scipy.stats.ttest_rel`</span>

<span class="sd">    Rows with missing values in any of the features will be dropped.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `feature1` and `feature2` in columns</span>
<span class="sd">    feature1: str</span>
<span class="sd">        Name of the first feature</span>
<span class="sd">    feature2: str</span>
<span class="sd">        Name of the second feature</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_t_test: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, features, means, stds,</span>
<span class="sd">                                mean difference, t-value, degrees of freedom, p-value, significance)</span>
<span class="sd">    residplot: Figure</span>
<span class="sd">        Figure if plot == True, else None</span>
<span class="sd">    boxplot: Figure</span>
<span class="sd">        Figure if plot == True, else None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; bill_and_tip_difference, _, _ = dependent_t_test(tips, &#39;total_bill&#39;, &#39;tip&#39;, show = True, plot = False)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># select feature1 featur2 columns and remove row if any nan present</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_descriptive</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

    <span class="c1"># Raise error if features are not numeric</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">feature</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features (</span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2">) should be numeric&quot;</span><span class="p">)</span>

    <span class="c1"># Perform t test</span>
    <span class="p">(</span><span class="n">t_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_rel</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">feature1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">feature2</span><span class="p">])</span>
    <span class="n">degrees_freedom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">feature1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">feature2</span><span class="p">]</span>
    <span class="c1"># Confidence interval</span>
    <span class="n">critical_t</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">degrees_freedom</span><span class="p">)</span>
    <span class="n">critical_z</span> <span class="o">=</span> <span class="mf">1.96</span>
    <span class="n">moe</span> <span class="o">=</span> <span class="n">critical_t</span> <span class="o">*</span> <span class="n">diff</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">moe_z</span> <span class="o">=</span> <span class="n">critical_z</span> <span class="o">*</span> <span class="n">diff</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;========= Paired sample t-tests between [ </span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2"> ] </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pairs with missing values are dropped</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Summary of the data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_descriptive</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print results t-test</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- t-value = </span><span class="si">{</span><span class="n">t_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- degrees of freedom = </span><span class="si">{</span><span class="n">degrees_freedom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Difference between the two groups is </span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">moe</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">moe</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">] (mean [95% CI])&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Confidence interval based on z [</span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">moe_z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">moe_z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">] ([95% CI])&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance detected&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance NOT detected&quot;</span><span class="p">)</span>

    <span class="n">residplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">boxplot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># Assumption check: normality of residuals</span>
        <span class="n">residplot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span> <span class="n">rug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Check distribution of residuals </span><span class="se">\n</span><span class="s2"> res = </span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Plot the data</span>
        <span class="n">boxplot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boxplot </span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># format for row data frame</span>
    <span class="n">feature1_mean_std</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">feature1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">feature1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">feature2_mean_std</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="c1"># Lakens, D. (2013). Calculating and reporting effect sizes to facilitate cumulative science:</span>
    <span class="c1"># a practical primer for t-tests and ANOVAs. Frontiers in psychology, 4, 863.</span>
    <span class="c1"># d = (t * np.sqrt((1 / n1 + 1 / n2)))</span>
    <span class="n">cohen_D</span> <span class="o">=</span> <span class="n">t_value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="n">feature1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="n">feature2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
    <span class="p">)</span>

    <span class="c1"># return result on a row data frame</span>
    <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;dependent T-test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;feature1&quot;</span><span class="p">:</span> <span class="n">feature1</span><span class="p">,</span>
        <span class="s2">&quot;n-sample1&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">feature1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s2">&quot;mean1 (std1)&quot;</span><span class="p">:</span> <span class="n">feature1_mean_std</span><span class="p">,</span>
        <span class="s2">&quot;feature2&quot;</span><span class="p">:</span> <span class="n">feature2</span><span class="p">,</span>
        <span class="s2">&quot;n-sample2&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">feature2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s2">&quot;mean2 (std2)&quot;</span><span class="p">:</span> <span class="n">feature2_mean_std</span><span class="p">,</span>
        <span class="s2">&quot;mean-difference&quot;</span><span class="p">:</span> <span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s2">&quot;t-value&quot;</span><span class="p">:</span> <span class="n">t_value</span><span class="p">,</span>
        <span class="s2">&quot;cohen_D&quot;</span><span class="p">:</span> <span class="n">cohen_D</span><span class="p">,</span>
        <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">degrees_freedom</span><span class="p">,</span>
        <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
        <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df_result</span><span class="p">,</span> <span class="n">residplot</span><span class="p">,</span> <span class="n">boxplot</span></div>


<div class="viewcode-block" id="analysis_dependent_t_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.analysis_dependent_t_test">[docs]</a><span class="k">def</span> <span class="nf">analysis_dependent_t_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">)</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run `dependent_t_test` for all combinations of features</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `features` in columns</span>
<span class="sd">    features: list</span>
<span class="sd">        list with feature names (str)</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_analysis: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, features, means, stds,</span>
<span class="sd">                                mean difference, t-value, degrees of freedom, p-value, significance)</span>
<span class="sd">    list_residplots: list</span>
<span class="sd">        List with figures if plot == True, else with None</span>
<span class="sd">    list_boxplots: list</span>
<span class="sd">        List with figures if plot == True, else with None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; df_analysis, _, _ = analysis_dependent_t_test(tips, [&#39;total_bill&#39;, &#39;tip&#39;, &#39;size&#39;], show=True, plot=False)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize empty data frame</span>
    <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># initialize empty lists for figures</span>
    <span class="n">list_residplots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_boxplots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">df_t_test</span><span class="p">,</span> <span class="n">residplot</span><span class="p">,</span> <span class="n">boxplot</span> <span class="o">=</span> <span class="n">dependent_t_test</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">feature1</span><span class="o">=</span><span class="n">combination</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">feature2</span><span class="o">=</span><span class="n">combination</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add the results of the t-test to the general dataframe</span>
        <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df_analysis</span><span class="p">,</span> <span class="n">df_t_test</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Add the plots to the lists</span>
        <span class="n">list_residplots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residplot</span><span class="p">)</span>
        <span class="n">list_boxplots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boxplot</span><span class="p">)</span>

    <span class="c1"># Sort the plots by the p-values of the dataframe</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">list_residplots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_residplots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">list_boxplots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_boxplots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="c1"># Sort the results dataframe by p-values</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_analysis</span><span class="p">,</span> <span class="n">list_residplots</span><span class="p">,</span> <span class="n">list_boxplots</span></div>


<div class="viewcode-block" id="permute_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.permute_test">[docs]</a><span class="k">def</span> <span class="nf">permute_test</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">test_type</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Helper function to run tests for permutations</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : np.array</span>
<span class="sd">    test_type: str {&#39;correlation&#39;, &#39;independent_t_test&#39;}</span>
<span class="sd">        Type of the test to be used</span>
<span class="sd">    test:</span>
<span class="sd">        e.g. `scipy.stats.pearsonr` or `statsmodels.stats.weightstats.ttest_ind`</span>

<span class="sd">    **kwargs:</span>
<span class="sd">        Additional keywords to be added to `test`</span>
<span class="sd">        - `n` for the number of observations in the first group if test_type = &#39;independent_t_test&#39;</span>
<span class="sd">        - `usevar` for the type of variances if test_type = &#39;independent_t_test&#39;</span>
<span class="sd">        - `a2` for the second feature if test_type = &#39;correlation&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    float:</span>
<span class="sd">        p value for permutation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">test_type</span> <span class="o">==</span> <span class="s2">&quot;correlation&quot;</span><span class="p">:</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;a2&quot;</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">test_type</span> <span class="o">==</span> <span class="s2">&quot;independent_t_test&quot;</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span>
        <span class="n">usevar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;usevar&quot;</span><span class="p">,</span> <span class="s2">&quot;pooled&quot;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">:],</span> <span class="n">usevar</span><span class="o">=</span><span class="n">usevar</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">test_type</span> <span class="o">==</span> <span class="s2">&quot;mannwhitneyu&quot;</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown test_type provided&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="independent_t_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.independent_t_test">[docs]</a><span class="k">def</span> <span class="nf">independent_t_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">permutation_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run independent sample t-tests including assumptions using `scipy.stats.levene` and `statsmodels.stats.</span>
<span class="sd">    weightstats.ttest_ind`</span>

<span class="sd">    Rows with missing values in `features` or `grouping_var` will be dropped.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `feature` and `grouping_var` in columns</span>
<span class="sd">    feature: str</span>
<span class="sd">        Name of the feature</span>
<span class="sd">    grouping_var: str</span>
<span class="sd">        Name of the  column with grouping labels in `data`</span>
<span class="sd">    grouping_grp1: str</span>
<span class="sd">        Name of the first label in `data[grouping_var]`</span>
<span class="sd">    grouping_grp2: str</span>
<span class="sd">        Name of the second label in `data[grouping_var]`</span>
<span class="sd">    permutation_test: bool (default: False)</span>
<span class="sd">        If true, a permutation test will added</span>
<span class="sd">    n_permutations: int (default: 1000)</span>
<span class="sd">        Number of permutations in the permutation test</span>
<span class="sd">    random_state: None or int (default: None)</span>
<span class="sd">        Random state for permutation_test. If not None, random_state will be updated for every permutation</span>
<span class="sd">    show: bool (default: False)</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool (default: False)</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_t_test: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, feature, groups, means, stds,</span>
<span class="sd">                                Levenes test, t-value, degrees of freedom, p-value, significance)</span>
<span class="sd">    distplot: matplotlib.figure.Figure with distributions (if plot is True else None)</span>
<span class="sd">    boxplot: matplotlib.figure.Figure with data (if plot is True else None)</span>
<span class="sd">    p_plot: matplotlib.figure.Figure with permutation results (if plot and permutation_test else None)</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; sex_tip_difference, _, _, _ = independent_t_test(tips, &#39;tip&#39;,&#39;sex&#39;, &#39;Female&#39;, &#39;Male&#39;, show = True, plot = False)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># select the &#39;feature&#39; and &#39;grouping_var&#39; columns and remove row if any nan present</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">feature</span><span class="p">,</span> <span class="n">grouping_var</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>

    <span class="c1"># Raise error if feature is not numeric</span>
    <span class="k">if</span> <span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> should be numeric&quot;</span><span class="p">)</span>

    <span class="c1"># New dataframes</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">grouping_grp1</span><span class="p">]</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">grouping_grp2</span><span class="p">]</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># get descriptive values</span>
    <span class="n">df_descriptive</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_var</span><span class="p">)[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">grouping_grp1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">grouping_grp2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">index</span>
    <span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;One of the groups did not have any observations for </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;independent T-test&quot;</span><span class="p">,</span>
            <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature</span><span class="p">,</span>
            <span class="s2">&quot;group-var&quot;</span><span class="p">:</span> <span class="n">grouping_var</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Store descriptives</span>
    <span class="n">mean_group1</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp1</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="n">mean_group2</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="n">std_group1</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp1</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span>
    <span class="n">std_group2</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span>

    <span class="c1"># Check assumption: homogeneity of variances</span>
    <span class="p">(</span><span class="n">levene</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">levene</span><span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;=== Independent t-tests: variable = *</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">* | group = *</span><span class="si">{</span><span class="n">grouping_grp1</span><span class="si">}</span><span class="s2">* &amp; *</span><span class="si">{</span><span class="n">grouping_grp2</span><span class="si">}</span><span class="s2">*&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; defined in *</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">* ===</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing values are dropped</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Describe the samples</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_descriptive</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print results Levenes test</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Levenes test for homogeneity of variances (H0 = homogeneity):&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- W = </span><span class="si">{</span><span class="n">levene</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2"> .3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">distplot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># Check assumpution: normally distributed within groups</span>
        <span class="n">distplot</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">distplot</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Check distribution within the groups&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">grouping_grp1</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">rugplot</span><span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">grouping_grp1</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">grouping_grp2</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">rugplot</span><span class="p">(</span><span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">grouping_grp2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="c1"># YES: Run t-test using statsmodels - unequal variance</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Unequal variances detected </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">group_variance</span> <span class="o">=</span> <span class="s2">&quot;Unequal&quot;</span>
        <span class="n">use_var</span> <span class="o">=</span> <span class="s2">&quot;unequal&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># NO: Run t-test using statsmodels - equal variances</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Equal variances detected </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">group_variance</span> <span class="o">=</span> <span class="s2">&quot;Equal&quot;</span>
        <span class="n">use_var</span> <span class="o">=</span> <span class="s2">&quot;pooled&quot;</span>

    <span class="c1"># Run the t-test</span>
    <span class="p">(</span><span class="n">t_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">degrees_freedom</span><span class="p">)</span> <span class="o">=</span> <span class="n">smsw</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span>
        <span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">usevar</span><span class="o">=</span><span class="n">use_var</span>
    <span class="p">)</span>

    <span class="c1"># Add cohen&#39;s D effect size (based on Rosenthal, R., Cooper, H., &amp; Hedges, L. (1994).</span>
    <span class="c1"># Parametric measures of effect size. The handbook of research synthesis, 621(2), 231-244.)</span>
    <span class="c1"># cohen_D = (mean1 -mean2) / np.sqrt(((n1-1)*var1 + (n2-1)*var2) / (n1 + n2 - 2))</span>

    <span class="n">cohen_D</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_group1</span> <span class="o">-</span> <span class="n">mean_group2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">std_group1</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">std_group2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Store results in dictionary</span>
    <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;independent T-test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature</span><span class="p">,</span>
        <span class="s2">&quot;group-var&quot;</span><span class="p">:</span> <span class="n">grouping_var</span><span class="p">,</span>
        <span class="s2">&quot;group1&quot;</span><span class="p">:</span> <span class="n">grouping_grp1</span><span class="p">,</span>
        <span class="s2">&quot;n-sample1&quot;</span><span class="p">:</span> <span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;mean1 (std1)&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_group1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">std_group1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;group2&quot;</span><span class="p">:</span> <span class="n">grouping_grp2</span><span class="p">,</span>
        <span class="s2">&quot;n-sample2&quot;</span><span class="p">:</span> <span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;mean2 (std2)&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_group2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">std_group2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;variances&quot;</span><span class="p">:</span> <span class="n">group_variance</span><span class="p">,</span>
        <span class="s2">&quot;t-value&quot;</span><span class="p">:</span> <span class="n">t_value</span><span class="p">,</span>
        <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">degrees_freedom</span><span class="p">,</span>
        <span class="s2">&quot;cohen_D&quot;</span><span class="p">:</span> <span class="n">cohen_D</span><span class="p">,</span>
        <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
        <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Run the permutation test</span>
    <span class="k">if</span> <span class="n">permutation_test</span><span class="p">:</span>
        <span class="n">total_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">]))</span>
        <span class="c1"># Copy the complete data</span>
        <span class="n">total_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">total_group</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">n_permutations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Shuffle within the columns</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">ix_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">total_group</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ix_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">total_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">total_group</span> <span class="o">=</span> <span class="n">total_group</span><span class="p">[</span><span class="n">ix_i</span><span class="p">,</span> <span class="n">ix_j</span><span class="p">]</span>
        <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
            <span class="n">permute_test</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">arr</span><span class="o">=</span><span class="n">total_group</span><span class="p">,</span>
            <span class="n">test_type</span><span class="o">=</span><span class="s2">&quot;independent_t_test&quot;</span><span class="p">,</span>
            <span class="n">test</span><span class="o">=</span><span class="n">smsw</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">group1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">usevar</span><span class="o">=</span><span class="n">use_var</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">extreme_permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">permutations</span> <span class="o">&lt;</span> <span class="n">p_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p_permutation</span> <span class="o">=</span> <span class="n">extreme_permutation</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span>
        <span class="n">dict_result</span><span class="p">[</span><span class="s2">&quot;permutation-p-value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_permutation</span>

        <span class="c1"># Reset random seed numpy</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="c1"># Print results t-test</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Outcome t-test: &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- t-value = </span><span class="si">{</span><span class="n">t_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- degrees of freedom = </span><span class="si">{</span><span class="n">degrees_freedom</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance detected&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance NOT detected&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">boxplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p_plot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># Plot the data</span>
        <span class="n">boxplot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="n">grouping_grp1</span><span class="p">])],</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="n">grouping_grp1</span><span class="p">])],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boxplot </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> across </span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add plot for permutations</span>
        <span class="k">if</span> <span class="n">permutation_test</span><span class="p">:</span>
            <span class="n">p_plot</span> <span class="o">=</span> <span class="n">permutation_plot</span><span class="p">(</span>
                <span class="n">permutations</span><span class="p">,</span>
                <span class="n">p_value</span><span class="p">,</span>
                <span class="n">feature1</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
                <span class="n">feature2</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Return results using a data frame</span>
    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_result</span><span class="p">,</span> <span class="n">distplot</span><span class="p">,</span> <span class="n">boxplot</span><span class="p">,</span> <span class="n">p_plot</span></div>


<div class="viewcode-block" id="analysis_independent_t_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.analysis_independent_t_test">[docs]</a><span class="k">def</span> <span class="nf">analysis_independent_t_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">permutation_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run `independent_t_test` for all combinations of features</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `features` and `grouping_var` in columns</span>
<span class="sd">    features: list</span>
<span class="sd">        list with feature names (str)</span>
<span class="sd">    grouping_var: str</span>
<span class="sd">        Name of the  column with grouping labels in `data`</span>
<span class="sd">    grouping_grp1: str</span>
<span class="sd">        Name of the first label in `data[grouping_var]`</span>
<span class="sd">    grouping_grp2: str</span>
<span class="sd">        Name of the second label in `data[grouping_var]`</span>
<span class="sd">    permutation_test: bool</span>
<span class="sd">        If true, a permutation test will added</span>
<span class="sd">    n_permutations: int (default: 1000)</span>
<span class="sd">        Number of permutations in the permutation test</span>
<span class="sd">    random_state: None or int (default: None)</span>
<span class="sd">        Random state for permutations</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_analysis: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, features, groups, means, stds,</span>
<span class="sd">                                Levenes test, t-value, degrees of freedom, p-value, significance)</span>
<span class="sd">    list_distplots: list</span>
<span class="sd">        List with figures if plot == True, else with None</span>
<span class="sd">    list_boxplots: list</span>
<span class="sd">        List with figures if plot == True, else with None</span>
<span class="sd">    list_p_plots: list</span>
<span class="sd">        List with figures if plot == True, else with None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; df_analysis, _, _, _ = analysis_independent_t_test(tips, [&#39;total_bill&#39;, &#39;tip&#39;, &#39;size&#39;], &#39;sex&#39;, &#39;Female&#39;, &#39;Male&#39;,</span>
<span class="sd">    &gt;&gt;&gt;                                           show=True, plot=False)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize empty data frame</span>
    <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># initialize empty lists for figures</span>
    <span class="n">list_distplots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_boxplots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_p_plots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># run t-test for every feature</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">df_t_test</span><span class="p">,</span> <span class="n">distplot</span><span class="p">,</span> <span class="n">boxplot</span><span class="p">,</span> <span class="n">p_plot</span> <span class="o">=</span> <span class="n">independent_t_test</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">feature</span><span class="p">,</span>
            <span class="n">grouping_var</span><span class="p">,</span>
            <span class="n">grouping_grp1</span><span class="p">,</span>
            <span class="n">grouping_grp2</span><span class="p">,</span>
            <span class="n">permutation_test</span><span class="o">=</span><span class="n">permutation_test</span><span class="p">,</span>
            <span class="n">n_permutations</span><span class="o">=</span><span class="n">n_permutations</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_analysis</span><span class="p">,</span> <span class="n">df_t_test</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">list_distplots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distplot</span><span class="p">)</span>
        <span class="n">list_boxplots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boxplot</span><span class="p">)</span>
        <span class="n">list_p_plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_plot</span><span class="p">)</span>

    <span class="c1"># Sort the plots by the p-values of the dataframe</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">list_distplots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_distplots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">list_boxplots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_boxplots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">list_p_plots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_p_plots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="c1"># sort results by p-value</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_analysis</span><span class="p">,</span> <span class="n">list_distplots</span><span class="p">,</span> <span class="n">list_boxplots</span><span class="p">,</span> <span class="n">list_p_plots</span></div>


<div class="viewcode-block" id="dependent_wilcoxon_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.dependent_wilcoxon_test">[docs]</a><span class="k">def</span> <span class="nf">dependent_wilcoxon_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">feature2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run paired sample Wilcoxon test using `scipy.stats.wilcoxon`</span>

<span class="sd">    Rows with missing values in any of the features will be dropped.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `feature1` and `feature2` in columns</span>
<span class="sd">    feature1: str</span>
<span class="sd">        Name of the first feature</span>
<span class="sd">    feature2: str</span>
<span class="sd">        Name of the second feature</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_t_test: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, features, means, stds,</span>
<span class="sd">                                mean difference, t-value, p-value, significance)</span>
<span class="sd">    boxplot: Figure</span>
<span class="sd">        Figure if plot == True, else None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; bill_and_tip_difference, _ = dependent_wilcoxon_test(tips, &#39;total_bill&#39;, &#39;tip&#39;, show = True, plot = True)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># select the &#39;feature1&#39; and &#39;feature2&#39; columns and remove row if any nan present</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>

    <span class="c1"># Descriptives</span>
    <span class="n">df_descriptive</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Raise error if features are not numeric</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">feature</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features (</span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2">) should be numeric&quot;</span><span class="p">)</span>

    <span class="c1"># Non parametrical test</span>
    <span class="n">t_value</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wilcoxon</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">feature1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">feature2</span><span class="p">])</span>

    <span class="c1"># format for row data frame</span>
    <span class="n">feature1_mean_std</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">feature1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">feature1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">feature2_mean_std</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">feature2</span><span class="p">,]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="c1"># Siegel, S., &amp; Castellan, N.J.(1988).Nonparametric statistics</span>
    <span class="c1"># for the behavioral sciences(2nd ed.)(pp 121).New York, NY: McGraw - Hill.</span>
    <span class="c1"># z = ((T - ((N*(N+1)) / 4)) / np.sqrt(((N*(N + 1) * (2*N + 1)) / 24)))</span>
    <span class="c1"># r = z / np.sqrt(N)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
        <span class="n">z_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_value</span> <span class="o">-</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">r_value</span> <span class="o">=</span> <span class="n">z_value</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z_value</span><span class="p">,</span> <span class="n">r_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># return result on a row data frame</span>
    <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;dependent Wilcoxon test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;feature1&quot;</span><span class="p">:</span> <span class="n">feature1</span><span class="p">,</span>
        <span class="s2">&quot;n-sample1&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">feature1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s2">&quot;mean1 (std1)&quot;</span><span class="p">:</span> <span class="n">feature1_mean_std</span><span class="p">,</span>
        <span class="s2">&quot;feature2&quot;</span><span class="p">:</span> <span class="n">feature2</span><span class="p">,</span>
        <span class="s2">&quot;n-sample2&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">feature2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s2">&quot;mean2 (std2)&quot;</span><span class="p">:</span> <span class="n">feature2_mean_std</span><span class="p">,</span>
        <span class="s2">&quot;t-value&quot;</span><span class="p">:</span> <span class="n">t_value</span><span class="p">,</span>
        <span class="s2">&quot;z-value&quot;</span><span class="p">:</span> <span class="n">z_value</span><span class="p">,</span>
        <span class="s2">&quot;r-value&quot;</span><span class="p">:</span> <span class="n">r_value</span><span class="p">,</span>
        <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
        <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;========= Paired sample Wilcoxon tests between [ </span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2"> ] </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Summary of the data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_descriptive</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Results Wilcoxon</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- t-value Wilcoxon signed rank test = </span><span class="si">{</span><span class="n">t_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- p-value wilcoxon signed rank test = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance detected&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance NOT detected&quot;</span><span class="p">)</span>

    <span class="n">boxplot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># Plot the data</span>
        <span class="n">boxplot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boxplot </span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_result</span><span class="p">,</span> <span class="n">boxplot</span></div>


<div class="viewcode-block" id="analysis_dependent_wilcoxon_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.analysis_dependent_wilcoxon_test">[docs]</a><span class="k">def</span> <span class="nf">analysis_dependent_wilcoxon_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">)</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run `dependent_wilcoxon_test` for all combinations of features</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `features` in columns</span>
<span class="sd">    features: list</span>
<span class="sd">        list with feature names (str)</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_analysis: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, features, means, stds,</span>
<span class="sd">                                mean difference, t-value, p-value, significance)</span>
<span class="sd">    list_boxplots: list</span>
<span class="sd">        List with figures if plot == True, else with None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; df_analysis, _ = analysis_dependent_wilcoxon_test(tips, [&#39;total_bill&#39;, &#39;tip&#39;, &#39;size&#39;], show=False, plot=False)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize empty data frame</span>
    <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1"># initialize empty list for plots</span>
    <span class="n">list_boxplots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># run t-test for all combinations of features</span>
    <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">df_wilcoxon_test</span><span class="p">,</span> <span class="n">boxplot</span> <span class="o">=</span> <span class="n">dependent_wilcoxon_test</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">feature1</span><span class="o">=</span><span class="n">combination</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">feature2</span><span class="o">=</span><span class="n">combination</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df_analysis</span><span class="p">,</span> <span class="n">df_wilcoxon_test</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">list_boxplots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boxplot</span><span class="p">)</span>

    <span class="c1"># Sort the plots by the p-values of the dataframe</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">list_boxplots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_boxplots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="c1"># Sort data based on p-value</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_analysis</span><span class="p">,</span> <span class="n">list_boxplots</span></div>


<div class="viewcode-block" id="independent_mannwhitneyu_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.independent_mannwhitneyu_test">[docs]</a><span class="k">def</span> <span class="nf">independent_mannwhitneyu_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">permutation_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run independent Mann-Whitney U test using `scipy.stats.mannwhitneyu`</span>

<span class="sd">    Rows with missing values in `feature` or `grouping_var` will be dropped.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `feature` and `grouping_var` in columns</span>
<span class="sd">    feature: str</span>
<span class="sd">        Name of the feature</span>
<span class="sd">    grouping_var: str</span>
<span class="sd">        Name of the  column with grouping labels in `data`</span>
<span class="sd">    grouping_grp1: str</span>
<span class="sd">        Name of the first label in `data[grouping_var]`</span>
<span class="sd">    grouping_grp2:</span>
<span class="sd">        Name of the second label in `data[grouping_var]`</span>
<span class="sd">    permutation_test: bool (default: False)</span>
<span class="sd">        If true, a permutation test will added</span>
<span class="sd">    n_permutations: int (default: 1000)</span>
<span class="sd">        Number of permutations in the permutation test</span>
<span class="sd">    random_state: None or int (default: None)</span>
<span class="sd">        Random state for permutation_test. If not None, random_state will be updated for every permutation</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_t_test: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, feature, groups, means, stds,</span>
<span class="sd">                                                         u-value, p-value, significance)</span>
<span class="sd">    boxplot: Figure</span>
<span class="sd">        Figure if plot == True, else None</span>
<span class="sd">    p_plot: Figure</span>
<span class="sd">        Figure if plot == True, else None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; sex_tip_difference, _, _ = independent_mannwhitneyu_test(tips, &#39;tip&#39;,&#39;sex&#39;, &#39;Female&#39;, &#39;Male&#39;, show = True,</span>
<span class="sd">    ...                                                       plot = True)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># select the &#39;feature&#39; and &#39;grouping_var&#39; columns and remove row if any nan present</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">feature</span><span class="p">,</span> <span class="n">grouping_var</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>

    <span class="c1"># Raise error if feature is not numeric</span>
    <span class="k">if</span> <span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> should be numeric&quot;</span><span class="p">)</span>

    <span class="c1"># New dataframes</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">grouping_grp1</span><span class="p">]</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">grouping_grp2</span><span class="p">]</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># get descriptive values</span>
    <span class="n">df_descriptive</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_var</span><span class="p">)[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">grouping_grp1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">grouping_grp2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">index</span>
    <span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;One of the groups did not have any observations for </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;independent MannwhitneyU test&quot;</span><span class="p">,</span>
            <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature</span><span class="p">,</span>
            <span class="s2">&quot;group-var&quot;</span><span class="p">:</span> <span class="n">grouping_var</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">mean_group1</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp1</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="n">mean_group2</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="n">std_group1</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp1</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span>
    <span class="n">std_group2</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span>

    <span class="c1"># Run nonparametric test</span>
    <span class="p">(</span><span class="n">u_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;=== Independent Mann-Whitney U: variable = *</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">* | group = *</span><span class="si">{</span><span class="n">grouping_grp1</span><span class="si">}</span><span class="s2">* &amp; *</span><span class="si">{</span><span class="n">grouping_grp2</span><span class="si">}</span><span class="s2">*&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; defined in *</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">* ===</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Describe the samples</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_descriptive</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mann-Whitney U = </span><span class="si">{</span><span class="n">u_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mann-Whitney p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance detected&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance NOT detected&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># return result on a row data frame</span>
    <span class="n">group1_mean_std</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean_group1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">std_group1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">group2_mean_std</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean_group2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">std_group2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="c1"># Siegel, S., &amp; Castellan, N.J.(1988).Nonparametric statistics</span>
    <span class="c1"># for the behavioral sciences(2nd ed.)(pp 121).New York, NY: McGraw - Hill.</span>
    <span class="c1"># z = ((u - ((n1*n2)/2))/ np.sqrt((n1*n2*(n1 + n2 + 1))/12))</span>
    <span class="c1"># r = z / np.sqrt(N)</span>
    <span class="n">n_group1</span> <span class="o">=</span> <span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">n_group2</span> <span class="o">=</span> <span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n_group1</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">n_group2</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">z_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_value</span> <span class="o">-</span> <span class="p">((</span><span class="n">n_group1</span> <span class="o">*</span> <span class="n">n_group2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">n_group1</span> <span class="o">*</span> <span class="n">n_group2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_group1</span> <span class="o">+</span> <span class="n">n_group2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">12</span>
        <span class="p">)</span>
        <span class="n">r_value</span> <span class="o">=</span> <span class="n">z_value</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_group1</span> <span class="o">+</span> <span class="n">n_group2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z_value</span><span class="p">,</span> <span class="n">r_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;independent MannwhitneyU test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature</span><span class="p">,</span>
        <span class="s2">&quot;group-var&quot;</span><span class="p">:</span> <span class="n">grouping_var</span><span class="p">,</span>
        <span class="s2">&quot;group1&quot;</span><span class="p">:</span> <span class="n">grouping_grp1</span><span class="p">,</span>
        <span class="s2">&quot;n-sample1&quot;</span><span class="p">:</span> <span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;mean1 (std1)&quot;</span><span class="p">:</span> <span class="n">group1_mean_std</span><span class="p">,</span>
        <span class="s2">&quot;group2&quot;</span><span class="p">:</span> <span class="n">grouping_grp2</span><span class="p">,</span>
        <span class="s2">&quot;n-sample2&quot;</span><span class="p">:</span> <span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;mean2 (std2)&quot;</span><span class="p">:</span> <span class="n">group2_mean_std</span><span class="p">,</span>
        <span class="s2">&quot;u-value&quot;</span><span class="p">:</span> <span class="n">u_value</span><span class="p">,</span>
        <span class="s2">&quot;z-value&quot;</span><span class="p">:</span> <span class="n">z_value</span><span class="p">,</span>
        <span class="s2">&quot;r-value&quot;</span><span class="p">:</span> <span class="n">r_value</span><span class="p">,</span>
        <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
        <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Run the permutation test</span>
    <span class="k">if</span> <span class="n">permutation_test</span><span class="p">:</span>
        <span class="n">total_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group1</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group2</span><span class="p">[</span><span class="n">feature</span><span class="p">]))</span>
        <span class="c1"># Copy the complete data</span>
        <span class="n">total_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">total_group</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">n_permutations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Shuffle within the columns</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">ix_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">total_group</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ix_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">total_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">total_group</span> <span class="o">=</span> <span class="n">total_group</span><span class="p">[</span><span class="n">ix_i</span><span class="p">,</span> <span class="n">ix_j</span><span class="p">]</span>
        <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
            <span class="n">permute_test</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">arr</span><span class="o">=</span><span class="n">total_group</span><span class="p">,</span>
            <span class="n">test_type</span><span class="o">=</span><span class="s2">&quot;mannwhitneyu&quot;</span><span class="p">,</span>
            <span class="n">test</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">group1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">extreme_permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">permutations</span> <span class="o">&lt;</span> <span class="n">p_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p_permutation</span> <span class="o">=</span> <span class="n">extreme_permutation</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span>
        <span class="n">dict_result</span><span class="p">[</span><span class="s2">&quot;permutation-p-value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_permutation</span>

        <span class="c1"># Reset random seed numpy</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">boxplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p_plot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># Plot the data</span>
        <span class="n">boxplot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="n">grouping_grp1</span><span class="p">])],</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">grouping_grp2</span><span class="p">,</span> <span class="n">grouping_grp1</span><span class="p">])],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boxplot </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> across </span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add plot for permutations</span>
        <span class="k">if</span> <span class="n">permutation_test</span><span class="p">:</span>
            <span class="n">p_plot</span> <span class="o">=</span> <span class="n">permutation_plot</span><span class="p">(</span>
                <span class="n">permutations</span><span class="p">,</span>
                <span class="n">p_value</span><span class="p">,</span>
                <span class="n">feature1</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
                <span class="n">feature2</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_result</span><span class="p">,</span> <span class="n">boxplot</span><span class="p">,</span> <span class="n">p_plot</span></div>


<div class="viewcode-block" id="analysis_independent_mannwhitneyu_test"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.analysis_independent_mannwhitneyu_test">[docs]</a><span class="k">def</span> <span class="nf">analysis_independent_mannwhitneyu_test</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_grp2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">permutation_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run `independent_mannwhitneyu_test` for all features</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `features` and `grouping_var` in columns</span>
<span class="sd">    features: list</span>
<span class="sd">        list with feature names (str)</span>
<span class="sd">    grouping_var: str</span>
<span class="sd">        Name of the  column with grouping labels in `data`</span>
<span class="sd">    grouping_grp1: str</span>
<span class="sd">        Name of the first label in `data[grouping_var]`</span>
<span class="sd">    grouping_grp2:</span>
<span class="sd">        Name of the second label in `data[grouping_var]`</span>
<span class="sd">    permutation_test: bool</span>
<span class="sd">        If true, a permutation test will added</span>
<span class="sd">    n_permutations: int (default: 1000)</span>
<span class="sd">        Number of permutations in the permutation test</span>
<span class="sd">    random_state: None or int (default: None)</span>
<span class="sd">        Random state for permutations</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_analysis: pandas.DataFrame</span>
<span class="sd">        Dataframe with most important results (name of the test, features, groups, means, stds,</span>
<span class="sd">                                                        u-value, p-value, significance)</span>
<span class="sd">    list_boxplots: list</span>
<span class="sd">        List with figures if plot == True, else None</span>
<span class="sd">    list_p_plots: list</span>
<span class="sd">        List with figures if plot == True, else None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; df_analysis, _, _ = analysis_independent_mannwhitneyu_test(tips, [&#39;total_bill&#39;, &#39;tip&#39;, &#39;size&#39;], &#39;sex&#39;, &#39;Female&#39;,</span>
<span class="sd">    ...                                                      &#39;Male&#39;, show = True, plot = False)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize empty data frame</span>
    <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1"># initialize empty lists for figures</span>
    <span class="n">list_boxplots</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_p_plots</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">df_mannwhitneyu_test</span><span class="p">,</span> <span class="n">boxplot</span><span class="p">,</span> <span class="n">p_plot</span> <span class="o">=</span> <span class="n">independent_mannwhitneyu_test</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">feature</span><span class="p">,</span>
            <span class="n">grouping_var</span><span class="p">,</span>
            <span class="n">grouping_grp1</span><span class="p">,</span>
            <span class="n">grouping_grp2</span><span class="p">,</span>
            <span class="n">permutation_test</span><span class="o">=</span><span class="n">permutation_test</span><span class="p">,</span>
            <span class="n">n_permutations</span><span class="o">=</span><span class="n">n_permutations</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">df_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df_analysis</span><span class="p">,</span> <span class="n">df_mannwhitneyu_test</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">list_boxplots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boxplot</span><span class="p">)</span>
        <span class="n">list_p_plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_plot</span><span class="p">)</span>

    <span class="c1"># Sort the plots by the p-values of the dataframe</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">list_boxplots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_boxplots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">list_p_plots</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_p_plots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="c1"># Sort the results based on p-value</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_analysis</span><span class="p">,</span> <span class="n">list_boxplots</span><span class="p">,</span> <span class="n">list_p_plots</span></div>


<div class="viewcode-block" id="one_way_ANOVA"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.one_way_ANOVA">[docs]</a><span class="k">def</span> <span class="nf">one_way_ANOVA</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">grouping_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">groups_of_interest</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
    <span class="n">col_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run one-way ANOVAs using `scipy.stats.f_oneway` and check homogeneity of variances with Levenes test</span>
<span class="sd">    using `scipy.stats.levene`</span>

<span class="sd">    `one_way_ANOVA` assumes equal variances within the groups and will not give a warning if show=False</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame)</span>
<span class="sd">        Dataframe with `feature` and `grouping_var` in columns</span>
<span class="sd">    feature: str</span>
<span class="sd">        Name of the feature</span>
<span class="sd">    grouping_var: str</span>
<span class="sd">        Name of the  column with grouping labels in `data`</span>
<span class="sd">    groups_of_interest: list</span>
<span class="sd">        Names (str) of labels in `data[grouping_var]`</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the distribution and the data</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>
<span class="sd">    col_wrap: int or None (default: None)</span>
<span class="sd">        If int, number of subplots that are allowed in a single row</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_result: pd.DataFrame</span>
<span class="sd">    df_descriptive: pd.DataFrame</span>
<span class="sd">    distplot: Figure</span>
<span class="sd">        Figure if plot == True, else None</span>
<span class="sd">    boxplot: Figure</span>
<span class="sd">        Figure if plot == True, else None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; _, _, _, _ = one_way_ANOVA(tips, &#39;tip&#39;, &#39;day&#39;, [&#39;Sat&#39;,&#39;Sun&#39;,&#39;Thur&#39;], show = True, plot = False)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># select the &#39;feature&#39; and &#39;grouping_var&#39; columns and remove row if any nan present</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">feature</span><span class="p">,</span> <span class="n">grouping_var</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>

    <span class="c1"># Raise error if feature is not numeric</span>
    <span class="k">if</span> <span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> should be numeric&quot;</span><span class="p">)</span>

    <span class="c1"># select the groups of interest and remove any not used category from the categorical index</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">groups_of_interest</span><span class="p">),</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">()</span>

    <span class="c1"># get descriptive values, keep only interested rows</span>
    <span class="n">df_descriptive</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_var</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df_descriptive</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Raise warning if groups of interest not in the dataframe</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">grp</span> <span class="ow">in</span> <span class="n">df_descriptive</span><span class="p">[</span><span class="n">grouping_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">groups_of_interest</span>
    <span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;One of the groups did not have any observations for </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">values_per_group</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">grp_label</span><span class="p">:</span> <span class="n">values</span>
        <span class="k">for</span> <span class="n">grp_label</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_var</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">feature</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Check assumption: homogeneity of variances</span>
    <span class="p">(</span><span class="n">levene</span><span class="p">,</span> <span class="n">levene_p_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">levene</span><span class="p">(</span><span class="o">*</span><span class="n">values_per_group</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">levene_p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="c1"># Equal variances:</span>
        <span class="n">variance_outcome</span> <span class="o">=</span> <span class="s2">&quot;Equal&quot;</span>
        <span class="n">trust_results</span> <span class="o">=</span> <span class="s2">&quot;trustworthy&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Unequal variances: ANOVA cannot be trusted</span>
        <span class="n">variance_outcome</span> <span class="o">=</span> <span class="s2">&quot;Unequal&quot;</span>
        <span class="n">trust_results</span> <span class="o">=</span> <span class="s2">&quot;untrustworthy&quot;</span>

    <span class="c1"># Run one way ANOVA</span>
    <span class="p">(</span><span class="n">f_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_oneway</span><span class="p">(</span><span class="o">*</span><span class="n">values_per_group</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Lakens, D.(2013).Calculating and reporting effect sizes to facilitate cumulative science:</span>
    <span class="c1"># a practical primer for t - tests and ANOVAs.Frontiers in psychology, 4, 863.</span>
    <span class="c1"># eta_squared = ((f * df_effect) / ((f * df_effect) + df_error))</span>

    <span class="n">df_effect</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups_of_interest</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">df_error</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="n">df_effect</span>
    <span class="n">eta_squared</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_value</span> <span class="o">*</span> <span class="n">df_effect</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">f_value</span> <span class="o">*</span> <span class="n">df_effect</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_error</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;=== One-way anova: variable = *</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">* | groups = *</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups_of_interest</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;* defined in *</span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">* ===</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing values are dropped</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Describe the samples</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_descriptive</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print results Levenes test</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Levenes test for homogeneity of variances (H0 = homogeneity):&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- W = </span><span class="si">{</span><span class="n">levene</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- p-value = </span><span class="si">{</span><span class="n">levene_p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">levene_p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="c1"># Equal variances:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Equal variances detected </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;- Unequal variances detected by Levenes test, so ANOVA results might be untrustworthy&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Print results ANOVA</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outcome ANOVA: &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- F-value = </span><span class="si">{</span><span class="n">f_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- df_effect = </span><span class="si">{</span><span class="n">df_effect</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- df_error = </span><span class="si">{</span><span class="n">df_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance detected&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Statistical significance NOT detected&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">distplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">boxplot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># Check assumpution: normally distributed within groups</span>
        <span class="n">distplot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Check distribution within the groups&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">distplot</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">distplot</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">rugplot</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

        <span class="c1"># Plot the data</span>
        <span class="n">boxplot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">grouping_var</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.50</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boxplot </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> across </span><span class="si">{</span><span class="n">grouping_var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dict_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test-type&quot;</span><span class="p">:</span> <span class="s2">&quot;one way ANOVA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature</span><span class="p">,</span>
        <span class="s2">&quot;group-var&quot;</span><span class="p">:</span> <span class="n">grouping_var</span><span class="p">,</span>
        <span class="s2">&quot;f-value&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">f_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s2">&quot;eta-squared&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">eta_squared</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s2">&quot;df-effect&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_effect</span><span class="p">),</span>
        <span class="s2">&quot;df-error&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_error</span><span class="p">),</span>
        <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
        <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">variance_outcome</span><span class="p">,</span>
        <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">trust_results</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df_result</span><span class="p">,</span> <span class="n">df_descriptive</span><span class="p">,</span> <span class="n">distplot</span><span class="p">,</span> <span class="n">boxplot</span></div>


<div class="viewcode-block" id="mapping_dist_mean_median"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.mapping_dist_mean_median">[docs]</a><span class="k">def</span> <span class="nf">mapping_dist_mean_median</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Adds line and text relative to moments of distribution to densityplots using `seaborn.distplots`</span>

<span class="sd">    Helper function (map) for plotting distributions, can be used with `plot_distribution`</span>
<span class="sd">    Adds dashed line at mean value and solid line at median value.</span>
<span class="sd">    Adds text with mean, median, skewness, kurtosis values at right top of the plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    (**kwargs)</span>
<span class="sd">        arguments passed by `plot_distribution` or `seaborn.FacetGrid`: `data`, `bins`, `**kwargs`</span>


<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    function</span>
<span class="sd">        Plotting functions to be used in `plot_distribution`</span>

<span class="sd">    See Also</span>
<span class="sd">    ----------</span>
<span class="sd">    frequentist_statistics_preparation.plot_distribution</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;).select_dtypes(include=&#39;number&#39;)</span>
<span class="sd">    &gt;&gt;&gt; tips_melted = tips.melt(var_name=&#39;feature&#39;, value_name=&#39;values&#39;)</span>
<span class="sd">    &gt;&gt;&gt; g = sns.FacetGrid(tips_melted, col=&quot;feature&quot;, sharex=False, sharey=True)</span>
<span class="sd">    &gt;&gt;&gt; _ = (g.map(mapping_dist_mean_median, &quot;values&quot;, bins=10)</span>
<span class="sd">    ...    .set(ylim=(0, 1))</span>
<span class="sd">    ...    .set_titles(&quot;{col_name}&quot;)</span>
<span class="sd">    ...    .set_xlabels(&quot;&quot;)</span>
<span class="sd">    ...    .fig.subplots_adjust(wspace=.2, hspace=.3))</span>
<span class="sd">    &gt;&gt;&gt; # _ = plt.show()</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># plot distribution</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">rugplot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># find min and max x in the plot to allign text</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
    <span class="n">x_pos</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.325</span>

    <span class="c1"># add mean (dashed line and text)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_pos</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;Mean: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>

    <span class="c1"># add median (solid line and text)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_pos</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">,</span> <span class="s2">&quot;Median: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">median</span><span class="p">()))</span>

    <span class="c1"># add skewness and kurtosis (text only)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x_pos</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;Skewness: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x_pos</span><span class="p">,</span>
        <span class="mf">0.80</span><span class="p">,</span>
        <span class="s2">&quot;Kurtosis: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fisher</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;propagate&quot;</span><span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="plot_distribution"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.plot_distribution">[docs]</a><span class="k">def</span> <span class="nf">plot_distribution</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">col_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot distributions relative to numerical (ungrouped) features</span>

<span class="sd">    Wrapper of `seaborn.FacetGrid` that uses plotting function `dist_mean_median` to plot distributions and displays</span>
<span class="sd">    the moments of the distribution for numerical columns in `data`</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        Dataframe containing the features of interest</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>
<span class="sd">    col_wrap: int or None (default: None)</span>
<span class="sd">        If int, number of subplots that are allowed in a single row</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    distplot: Figure</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; _ = plot_distribution(tips)</span>
<span class="sd">    &gt;&gt;&gt; # plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># consider only numerical features and build a new df with two columns: [&#39;feature&#39; | &#39;values&#39;]</span>
    <span class="n">data_numerical</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
    <span class="n">data_numerical_m</span> <span class="o">=</span> <span class="n">data_numerical</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">)</span>

    <span class="c1"># subplots for every numerical column</span>
    <span class="n">distplot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span>
        <span class="n">data_numerical_m</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">distplot</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># distplot with mean and median lines and values</span>
    <span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">distplot</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapping_dist_mean_median</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_titles</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{col_name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_xlabels</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">distplot</span></div>


<div class="viewcode-block" id="ecdf"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.ecdf">[docs]</a><span class="k">def</span> <span class="nf">ecdf</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes emperical cumulative distribution function for a one-dimensional array of measurements.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.Series</span>
<span class="sd">        series with measurements</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    x: pandas.Series</span>
<span class="sd">        sorted data</span>
<span class="sd">    y: pandas.Series</span>
<span class="sd">        cumulative distribution</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; bills = sns.load_dataset(&quot;tips&quot;)[&#39;total_bill&#39;]</span>
<span class="sd">    &gt;&gt;&gt; x, y = ecdf(bills)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Number of data points: n</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># x-data for the ECDF: x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># y-data for the ECDF: y</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>


<div class="viewcode-block" id="mapping_ecdf"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.mapping_ecdf">[docs]</a><span class="k">def</span> <span class="nf">mapping_ecdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Adds emperical and theoretical distribution of the data</span>

<span class="sd">    Helper function (map) for plotting distributions, can be used with `compare_theoretical_ecdf`</span>
<span class="sd">    Adds solid line at theoretical distribution</span>
<span class="sd">    Adds points at emperical data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    (**kwargs)</span>
<span class="sd">        arguments passed by `compare_theoretical_ecdf` or `seaborn.FacetGrid`: `data`, `**kwargs`</span>


<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    function</span>
<span class="sd">        Plotting functions to be used in `compare_theoretical_ecdf`</span>

<span class="sd">    See Also</span>
<span class="sd">    ----------</span>
<span class="sd">    frequentist_statistics_preparation.compare_theoretical_ecdf</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;).select_dtypes(include=&#39;number&#39;)</span>
<span class="sd">    &gt;&gt;&gt; tips_melted = tips.melt(var_name=&#39;feature&#39;, value_name=&#39;values&#39;)</span>
<span class="sd">    &gt;&gt;&gt; g = sns.FacetGrid(tips_melted, col=&quot;feature&quot;, sharex=False, sharey=True)</span>
<span class="sd">    &gt;&gt;&gt; _ = (g.map(mapping_ecdf, &quot;values&quot;)</span>
<span class="sd">    ...    .set(ylim=(0, 1))</span>
<span class="sd">    ...    .set_titles(&quot;{col_name}&quot;)</span>
<span class="sd">    ...    .set_xlabels(&quot;&quot;)</span>
<span class="sd">    ...    .fig.subplots_adjust(wspace=.2, hspace=.3))</span>
<span class="sd">    &gt;&gt;&gt; # _ = plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute mean and standard deviation from data: mu, sigma</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Sample out of a normal distribution with this mu and sigma: samples</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    <span class="c1"># Get the CDF of the samples and of the data</span>
    <span class="n">x_theor</span><span class="p">,</span> <span class="n">y_theor</span> <span class="o">=</span> <span class="n">ecdf</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
    <span class="n">x_emp</span><span class="p">,</span> <span class="n">y_emp</span> <span class="o">=</span> <span class="n">ecdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Plot the CDFs</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_theor</span><span class="p">,</span> <span class="n">y_theor</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_emp</span><span class="p">,</span> <span class="n">y_emp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="compare_theoretical_ecdf"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.compare_theoretical_ecdf">[docs]</a><span class="k">def</span> <span class="nf">compare_theoretical_ecdf</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span> <span class="n">col_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compare emperical distribution to the theoretical distribution based on mean and standard deviation</span>
<span class="sd">    Uses `mapping_ecdf` to plot the distributions and `ecdf` to calculate the distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame</span>
<span class="sd">        Dataframe including numerical features for which distribution is checked</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>
<span class="sd">    col_wrap: int or None (default: None)</span>
<span class="sd">        If int, number of subplots that are allowed in a single row</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    ecdfplot: Figure</span>
<span class="sd">        Figure with emperical and theoretical distributions of all numerical variables in subplots</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; _ = compare_theoretical_ecdf(tips)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># consider only numerical features and build a new df with two columns: [&#39;feature&#39; | &#39;values&#39;]</span>
    <span class="n">data_numerical</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
    <span class="n">data_numerical_m</span> <span class="o">=</span> <span class="n">data_numerical</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">)</span>

    <span class="c1"># subplots for every numerical column</span>
    <span class="n">ecdfplot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span>
        <span class="n">data_numerical_m</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ecdfplot</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># ecdf for every column</span>
    <span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ecdfplot</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapping_ecdf</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">))</span>
        <span class="o">.</span><span class="n">set_titles</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{col_name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_xlabels</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_ylabels</span><span class="p">(</span><span class="s2">&quot;CDF&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Comparison between theoretical and empirical distributions&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecdfplot</span></div>


<div class="viewcode-block" id="normal_check"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.normal_check">[docs]</a><span class="k">def</span> <span class="nf">normal_check</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compare the distribution of numeric variables to a normal distribution using the Kolmogrov-Smirnov test</span>

<span class="sd">    Wrapper for `scipy.stats.kstest`: the empircal data is compared to a normally distributed variable with the</span>
<span class="sd">    same mean and standard deviation. A significant result (p &lt; 0.05) in the goodness of fit test means that the</span>
<span class="sd">    data is not normally distributed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame</span>
<span class="sd">        Dataframe including the columns of interest</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_normality_check: pd.DataFrame</span>
<span class="sd">        Dataframe with column names, p-values and an indication of normality</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; df_normality_check = normal_check(tips)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select numeric columns only</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># Compare distribution of each feature to a normal distribution with given mean and std</span>
    <span class="n">df_normality_check</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">num_features</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">kstest</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">N</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create a label that indicates whether a feature has a normal distribution or not</span>
    <span class="n">df_normality_check</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_normality_check</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_normality_check</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="s2">&quot;p-value&quot;</span><span class="p">]</span>
    <span class="n">df_normality_check</span><span class="p">[</span><span class="s2">&quot;normality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_normality_check</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.05</span>

    <span class="k">return</span> <span class="n">df_normality_check</span></div>


<div class="viewcode-block" id="apply_power_transformations"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.apply_power_transformations">[docs]</a><span class="k">def</span> <span class="nf">apply_power_transformations</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Transform data with log transformations and Box-cox transformations</span>

<span class="sd">    Columns that have values &lt;=0 will be rescaled before transformations.</span>
<span class="sd">    Any `numpy.nans` will be ignored and retained. However, a warning &#39;invalid value encountered in less equal&#39; is</span>
<span class="sd">    returned by `scipy.stats.boxcox` which can be ignored.</span>
<span class="sd">    Transformations</span>
<span class="sd">    - natural logarithm</span>
<span class="sd">    - base 10 logarithm</span>
<span class="sd">    - square root</span>
<span class="sd">    - inverse of square root</span>
<span class="sd">    - inverse</span>
<span class="sd">    - square</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pandas.DataFrame</span>
<span class="sd">        Dataframe with the features to be transformed</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    pandas.Dataframe</span>
<span class="sd">        Dataframe with original data and transformations. Abbrevations of the transformations are added to the feature</span>
<span class="sd">        names (i.e., ln, log10, box_sqrt, box_inv, box_square)</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; tips_transformed = apply_power_transformations(tips)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Leave original data untouched</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Check whether features have negative values or zeros</span>
    <span class="n">negative_values</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Features with negative values</span>
    <span class="n">features_any_negative</span> <span class="o">=</span> <span class="n">negative_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">negative_values</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="c1"># Features without any negative values</span>
    <span class="n">features_only_positive</span> <span class="o">=</span> <span class="n">negative_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">negative_values</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_only_positive</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Apply natural log</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ln_&quot;</span> <span class="o">+</span> <span class="n">features_only_positive</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_only_positive</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span>
        <span class="p">)</span>
        <span class="c1"># Apply log base 10</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;log10_&quot;</span> <span class="o">+</span> <span class="n">features_only_positive</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_only_positive</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span>
        <span class="p">)</span>
        <span class="c1"># Apply Box-cox transformations</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_sqrt_&quot;</span> <span class="o">+</span> <span class="n">features_only_positive</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_only_positive</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_sqrt_inv_&quot;</span> <span class="o">+</span> <span class="n">features_only_positive</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
            <span class="n">features_only_positive</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_inv_&quot;</span> <span class="o">+</span> <span class="n">features_only_positive</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_only_positive</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_square_&quot;</span> <span class="o">+</span> <span class="n">features_only_positive</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
            <span class="n">features_only_positive</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_any_negative</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Apply natural log</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ln_&quot;</span> <span class="o">+</span> <span class="n">features_any_negative</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_any_negative</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># Apply log base 10</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;log10_&quot;</span> <span class="o">+</span> <span class="n">features_any_negative</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_any_negative</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># Apply Box-cox transformations</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_sqrt_&quot;</span> <span class="o">+</span> <span class="n">features_any_negative</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_any_negative</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_sqrt_inv_&quot;</span> <span class="o">+</span> <span class="n">features_any_negative</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
            <span class="n">features_any_negative</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lmbda</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_inv_&quot;</span> <span class="o">+</span> <span class="n">features_any_negative</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_any_negative</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lmbda</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box_square_&quot;</span> <span class="o">+</span> <span class="n">features_any_negative</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_any_negative</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="find_optimal_transformation"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.find_optimal_transformation">[docs]</a><span class="k">def</span> <span class="nf">find_optimal_transformation</span><span class="p">(</span>
    <span class="n">normality_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">prefix_list</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;ln_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;log10_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;box_sqrt_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;box_sqrt_inv_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;box_inv_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;box_square_&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Choose the best transformation based on the results of `normal_check` after `apply_transformation`</span>
<span class="sd">    If no transformation returns a normal distribution, the original feature should be used with nonparametric methods</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    df_normality_check: pandas.DataFrame</span>
<span class="sd">        Dataframe that includes feature (str), p-value (float) and normality (bool)</span>
<span class="sd">    feature_list: list</span>
<span class="sd">        List with the original feature names, corresponding to parts of the column names in df_normality_check (i.e.</span>
<span class="sd">        the original feature names)</span>
<span class="sd">    prefix_list: list</span>
<span class="sd">        List with the prefixes that were added to the original feature names in the feature_list</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    use_transformation: list</span>
<span class="sd">        optimal transformation for each feature</span>
<span class="sd">    use_nonparametric: list</span>
<span class="sd">        features for which no appropriate transformation was available</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; tips = sns.load_dataset(&quot;tips&quot;)</span>
<span class="sd">    &gt;&gt;&gt; #Assumption: all columns need transformations</span>
<span class="sd">    &gt;&gt;&gt; tips_transformed = apply_power_transformations(tips.select_dtypes(&#39;number&#39;))</span>
<span class="sd">    &gt;&gt;&gt; df_normality_check = normal_check(tips_transformed)</span>
<span class="sd">    &gt;&gt;&gt; use_transformation, use_nonparametric = find_optimal_transformation(df_normality_check,</span>
<span class="sd">    ... tips.select_dtypes(&#39;number&#39;).columns)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize lists</span>
    <span class="n">use_transformation</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">use_nonparametric</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="c1"># Select feature and transformations</span>
        <span class="n">search_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">feature</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">feature</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prefix_list</span>
        <span class="p">]</span>
        <span class="n">df_selection_feature</span> <span class="o">=</span> <span class="n">normality_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">normality_df</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">search_strings</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="c1"># If any of the transformations yielded a normal distribution, find the optimal transformation</span>
        <span class="k">if</span> <span class="n">df_selection_feature</span><span class="p">[</span><span class="s2">&quot;normality&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Select highest p-value (distribution )</span>
            <span class="n">optimal_feature</span> <span class="o">=</span> <span class="n">df_selection_feature</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">][</span>
                <span class="n">df_selection_feature</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="n">use_transformation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimal_feature</span><span class="p">)</span>

        <span class="c1"># If none of the transformations yielded a normal distribution, return the original feature</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_nonparametric</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">use_transformation</span><span class="p">,</span> <span class="n">use_nonparametric</span></div>


<div class="viewcode-block" id="ols"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.ols">[docs]</a><span class="k">def</span> <span class="nf">ols</span><span class="p">(</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
    <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">impute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">imputation_strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
    <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;nonrobust&quot;</span><span class="p">,</span>
    <span class="n">cov_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run a linear regression model with ordinary least squares (OLS) estimation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X: pandas.DataFrame</span>
<span class="sd">        Dataframe with predictors</span>
<span class="sd">    y: pandas.Series</span>
<span class="sd">        Series with outcome</span>
<span class="sd">    fit_intercept:  bool</span>
<span class="sd">        whether to add an intercept to the model</span>
<span class="sd">    normalize: bool</span>
<span class="sd">        whether to mean center and scale the numerical predictors (z-scores)</span>
<span class="sd">    impute: bool</span>
<span class="sd">        whether to impute missing values (`np.nan`) in numerical predictors in X</span>
<span class="sd">    imputation_strategy: {&#39;mean&#39;, &#39;median&#39;, &#39;most_frequent&#39;} (default=&#39;median&#39;)</span>
<span class="sd">        imputation strategy when impute=True</span>
<span class="sd">    show: bool</span>
<span class="sd">        whether to print the main results</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to show plots with model diagnostics</span>
<span class="sd">        if missing values in the data are not imputed, it is not possible to show model diagnostics</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>
<span class="sd">    cov_type: str</span>
<span class="sd">        covariance estimator, see statsmodels.regression.linear_model.RegressionResults.get_robustcov_results for</span>
<span class="sd">        available covariance estimators</span>
<span class="sd">    cov_kwds: list or None, optional</span>
<span class="sd">        See statsmodels.regression.linear_model.RegressionResults.get_robustcov_results for a description of the</span>
<span class="sd">        required keyswords for alternative covariance estimators</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    df_coef: pandas.DataFrame</span>
<span class="sd">        Dataframe with the results regarding coefficients: predictors, coefficients, standard errors, confidence</span>
<span class="sd">                                                        intervals, p-values</span>
<span class="sd">    df_fitting: pandas.DataFrame</span>
<span class="sd">        Dataframe with the results regarding model fit: outcome, number of observations, RMSE, F-value, df model,</span>
<span class="sd">                                                        df residuals, p-value, R-squared, adjusted R-squared</span>
<span class="sd">    diagplot: Figure</span>
<span class="sd">        Figure with model diagnostics if plot == True, else None</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; data = sns.load_dataset(name=&quot;mpg&quot;)</span>
<span class="sd">    &gt;&gt;&gt; y = data[&#39;mpg&#39;]</span>
<span class="sd">    &gt;&gt;&gt; X = data[[&#39;cylinders&#39;, &#39;displacement&#39;, &#39;weight&#39;, &#39;acceleration&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; coefs, fits, _ = ols(X, y, show=True, plot=True)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Lengths of X and y differ&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;y is not numeric&quot;</span><span class="p">)</span>

    <span class="c1"># Missing values handling in y</span>
    <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="c1"># Remove all observations that have missing y values</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;WARNING: y included missing values. These observations are dropped in both y and X&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">correct_y_indices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">correct_y_indices</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">correct_y_indices</span><span class="p">]</span>

    <span class="c1"># Standardize predictors</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="c1"># Split numerical and other predictors</span>
        <span class="n">X_num</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
        <span class="n">X_cat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>

        <span class="c1"># Normalize numerical predictors</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">X_num</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">index_names</span> <span class="o">=</span> <span class="n">X_num</span><span class="o">.</span><span class="n">index</span>
        <span class="n">X_num</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_num</span><span class="p">)</span>
        <span class="n">X_num</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_num</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index_names</span><span class="p">)</span>

        <span class="c1"># Add non-numerical predictors back</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_num</span><span class="p">,</span> <span class="n">X_cat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Missing values handling in X</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">impute</span><span class="p">:</span>
            <span class="c1"># Split numerical and other predictors</span>
            <span class="n">X_num</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
            <span class="n">X_cat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>

            <span class="c1"># Drop observations with missing values in non-numerical features</span>
            <span class="k">if</span> <span class="n">X_cat</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;WARNING: X included missing values in non-numerical features. These observations are &quot;</span>
                    <span class="s2">&quot;dropped in both y and X&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">correct_X_indices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">X_cat</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">correct_X_indices</span><span class="p">]</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">correct_X_indices</span><span class="p">]</span>

                <span class="c1"># Split numerical and other predictors</span>
                <span class="c1"># Split numerical and other predictors</span>
                <span class="n">X_num</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
                <span class="n">X_cat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>

            <span class="c1"># Impute missing values in numerical features X with imputation_stratgey</span>
            <span class="n">imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">missing_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">imputation_strategy</span><span class="p">)</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="n">X_num</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">index_names</span> <span class="o">=</span> <span class="n">X_num</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X_num</span> <span class="o">=</span> <span class="n">imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_num</span><span class="p">)</span>
            <span class="n">X_num</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_num</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index_names</span><span class="p">)</span>

            <span class="c1"># Add non-numerical predictors back</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_num</span><span class="p">,</span> <span class="n">X_cat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove all observations that have missing X values</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: X included missing values. These observations are dropped in both y and X&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">correct_X_indices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">correct_X_indices</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">correct_X_indices</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fit_intercept</span><span class="p">:</span>
        <span class="c1"># Add an intercept</span>
        <span class="n">X</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># use broadcast property</span>

    <span class="c1"># When non-numerical datatypes are present</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;WARNING: X included non-numerical features. Dummy variables will be created&quot;</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">cat_column</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="c1"># Make dummy variable</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">cat_column</span><span class="p">],</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">cat_column</span><span class="p">)),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cat_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Fit model</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">hasconst</span><span class="o">=</span><span class="n">fit_intercept</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="n">cov_kwds</span>
    <span class="p">)</span>

    <span class="c1"># Calculate RMSE</span>
    <span class="n">ypred</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">rmse_model</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ypred</span><span class="p">)</span>

    <span class="c1"># Wrap relevant OLS loadings info within a dataframe</span>
    <span class="n">coefficient_values</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span>
    <span class="n">coefficient_values</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;coef&quot;</span>

    <span class="n">p_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">coefficient_values</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;p-value&quot;</span>
    <span class="p">)</span>

    <span class="n">std_err</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">bse</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">coefficient_values</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;std-err&quot;</span><span class="p">)</span>

    <span class="n">conf_int_min</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">conf_int</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">coefficient_values</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;[0.025&quot;</span>
    <span class="p">)</span>

    <span class="n">conf_int_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">conf_int</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">coefficient_values</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;0.975]&quot;</span>
    <span class="p">)</span>

    <span class="n">df_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">coefficient_values</span><span class="p">,</span> <span class="n">std_err</span><span class="p">,</span> <span class="n">conf_int_min</span><span class="p">,</span> <span class="n">conf_int_max</span><span class="p">,</span> <span class="n">p_values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">df_coef</span><span class="p">[</span><span class="s2">&quot;stat-sign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_coef</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.05</span>

    <span class="c1"># Wrap relevant model info within a dataframe</span>

    <span class="c1"># to complete using info from</span>
    <span class="c1"># https://towardsdatascience.com/how-do-you-check-the-quality-of-your-regression-model-in-python-fa61759ff685</span>

    <span class="n">df_fitting</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;n-obs&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">nobs</span><span class="p">),</span>
            <span class="s2">&quot;rmse&quot;</span><span class="p">:</span> <span class="n">rmse_model</span><span class="p">,</span>
            <span class="s2">&quot;f-value&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">fvalue</span><span class="p">,</span>
            <span class="s2">&quot;df_effect&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">df_model</span><span class="p">,</span>
            <span class="s2">&quot;df_error&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">df_resid</span><span class="p">,</span>
            <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">f_pvalue</span><span class="p">,</span>
            <span class="s2">&quot;R-squared&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
            <span class="s2">&quot;Adj. R-squared&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">rsquared_adj</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Normalized residuals&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">resid_studentized_internal</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>

    <span class="n">diagplot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">diagplot</span> <span class="o">=</span> <span class="n">diagnostic_plots</span><span class="p">(</span><span class="n">model_fit</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_coef</span><span class="p">,</span> <span class="n">df_fitting</span><span class="p">,</span> <span class="n">diagplot</span></div>


<div class="viewcode-block" id="correct_pvalues"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.correct_pvalues">[docs]</a><span class="k">def</span> <span class="nf">correct_pvalues</span><span class="p">(</span>
    <span class="n">pvals</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fdr_bh&quot;</span><span class="p">,</span>
    <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct an array-like with pvalues using `method`, wrapper for `statsmodels.stats.multitest.multipletests`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pvals: array-like, 1d</span>
<span class="sd">        uncorrected pvalues</span>
<span class="sd">    alpha: float</span>
<span class="sd">        FWER, family-wise error rate</span>
<span class="sd">    method: str, one of {&#39;bonferroni&#39;, &#39;sidak&#39;, &#39;holm-sidak&#39;, &#39;holm&#39;, &#39;simes-hochberg&#39;, &#39;hommel&#39;, &#39;fdr_bh&#39;,</span>
<span class="sd">    &#39;fdr_by&#39;, &#39;fdr_tsbh&#39;, &#39;fdr_tsbky&#39;}</span>
<span class="sd">    plot: bool</span>
<span class="sd">        whether to plot the results</span>
<span class="sd">    title: str</span>
<span class="sd">        title to show above the plot</span>
<span class="sd">    labels: array-like, 1d</span>
<span class="sd">        labels for the uncorrected pvalues</span>
<span class="sd">    figsize: tuple</span>
<span class="sd">        size for the Figure</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    reject: numpy.array, bool</span>
<span class="sd">        true for hypothesis that can be rejected for given alpha</span>
<span class="sd">    corrected_p: numpy.array</span>
<span class="sd">        p-values corrected for multiple tests</span>
<span class="sd">    pvalues_plot: matplotlib.figure.Figure (optional)</span>
<span class="sd">        Figure if plot == True, else None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">pvals</span> <span class="o">=</span> <span class="n">pvals</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lengths of the pvals and the pvals_labels does not match&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">values</span>

    <span class="n">reject</span><span class="p">,</span> <span class="n">corrected_p</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multipletests</span><span class="p">(</span>
        <span class="n">pvals</span><span class="o">=</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">returnsorted</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Sort the pvalues and the labels (correct pvalues are sorted already)</span>
    <span class="n">sort_order</span> <span class="o">=</span> <span class="n">pvals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">pvals</span><span class="p">[</span><span class="n">sort_order</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">sort_order</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">])</span>

    <span class="c1"># Get colors for all pvalues</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#2167C5&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="s2">&quot;#EB5E23&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reject</span><span class="p">]</span>

    <span class="n">pvalues_plot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pvalues_plot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Plot pvalues and corrected pvalues, color dependent on &#39;reject&#39;</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">corrected_p</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Variable for pvalues length and number of pvalue</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Plot line at familywise p value</span>
        <span class="n">familywise_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">familywise_p</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>

        <span class="c1"># Add legend elements</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original p-values&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Corrected p-values&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#EB5E23&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Non-significant&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#2167C5&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Significant&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Alpha = </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span>
            <span class="p">),</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fdr_bh&quot;</span><span class="p">:</span>
            <span class="c1"># Plot a diagonal line to show the boundary pvalue</span>
            <span class="n">optimum_p</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">optimum_p</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">)</span>
            <span class="n">legend_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Line2D</span><span class="p">(</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Benjamini-Hochberg decision line&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add labels and legend</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$i$&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$p$&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reject</span><span class="p">,</span> <span class="n">corrected_p</span><span class="p">,</span> <span class="n">pvalues_plot</span></div>


<div class="viewcode-block" id="bland_altman_plot"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.bland_altman_plot">[docs]</a><span class="k">def</span> <span class="nf">bland_altman_plot</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">column1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">column2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">hue_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sd_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.96</span><span class="p">,</span>
    <span class="n">scatter_kwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">mean_line_kwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">limit_lines_kwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">plt_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a Bland-Altman Mean Difference Plot.</span>

<span class="sd">    The Bland-Altman Plot is a graphical method to analyze</span>
<span class="sd">    the differences between two methods of measurement.</span>
<span class="sd">    It is a way of quantifying the agreement of two clinical measures.</span>
<span class="sd">    The mean of the measures is plotted against their difference.</span>

<span class="sd">    For more information see</span>
<span class="sd">    https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4470095/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    data: pd.DataFrame</span>
<span class="sd">        The data frame from which data will be used for the plot.</span>
<span class="sd">    column1: str</span>
<span class="sd">        The name of the column of the first measure.</span>
<span class="sd">    column2: str</span>
<span class="sd">        The name of the column of the second measure.</span>
<span class="sd">    hue_column: str</span>
<span class="sd">        The name of the column used to color groups in the Bland Altman Plot.</span>
<span class="sd">    sd_limit: float</span>
<span class="sd">        The limit of agreements expressed in terms of the standard deviation of</span>
<span class="sd">        the differences. If `md` is the mean of the differences, and `sd` is</span>
<span class="sd">        the standard deviation of those differences, then the limits of</span>
<span class="sd">        agreement that will be plotted are md +/- sd_limit * sd.</span>
<span class="sd">        The default of 1.96 will produce 95% confidence intervals for the means</span>
<span class="sd">        of the differences. If sd_limit = 0, no limits will be plotted, and</span>
<span class="sd">        the ylimit of the plot defaults to 3 standard deviations on either</span>
<span class="sd">        side of the mean.</span>
<span class="sd">    scatter_kwds: dict</span>
<span class="sd">        Options to to style the scatter plot. Accepts any keywords for the</span>
<span class="sd">        matplotlib Axes.scatter plotting method.</span>
<span class="sd">    mean_line_kwds: dict</span>
<span class="sd">        Options to to style the scatter plot. Accepts any keywords for the</span>
<span class="sd">        matplotlib Axes.axhline plotting method.</span>
<span class="sd">    limit_lines_kwds: dict</span>
<span class="sd">        Options to style the scatter plot. Accepts any keywords for the</span>
<span class="sd">        matplotlib Axes.axhline plotting method.</span>
<span class="sd">    plt_title: str</span>
<span class="sd">        An optional string to overwrite the default title.</span>
<span class="sd">    figsize: tuple</span>
<span class="sd">        A tuple of numbers to be passed to the plt.figure(figsize= ) function</span>
<span class="sd">        to manually specify the size of the plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.figure.Figure</span>
<span class="sd">        The matplotlib.figure.Figure object that is shown when running the function</span>
<span class="sd">    ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">        The associated matplotlib.axes._subplots.AxesSubplot object of the plotted figure</span>
<span class="sd">    means: pd.Series</span>
<span class="sd">        The series of means that are plotted</span>
<span class="sd">    diffs: pd.Series</span>
<span class="sd">        The series of differences that are plotted</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Bland JM, Altman DG (1986). &quot;Statistical methods for assessing agreement</span>
<span class="sd">    between two methods of clinical measurement&quot;</span>
<span class="sd">    Giavarina D. (2015). Understanding Bland Altman analysis. Biochemia medica, 25(2), 141–151. https://doi.org/10.11613/BM.2015.015</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; # Load relevant libraries.</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.frequentist_statistics import bland_altman_plot</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>

<span class="sd">    &gt;&gt;&gt; # Making a bland-altman difference plot.</span>
<span class="sd">    &gt;&gt;&gt; # Seed the random number generator.</span>
<span class="sd">    &gt;&gt;&gt; # This ensures that the results below are reproducible.</span>
<span class="sd">    &gt;&gt;&gt; np.random.seed(69420)</span>
<span class="sd">    &gt;&gt;&gt; measure_1 = np.random.random(100)</span>
<span class="sd">    &gt;&gt;&gt; measure_2 = np.random.random(100)</span>
<span class="sd">    &gt;&gt;&gt; other_group_difference = np.random.choice([0, 1], 100)</span>

<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&quot;m1&quot;: measure_1, &quot;m2&quot;: measure_2, &quot;hue_column&quot;: other_group_difference})</span>

<span class="sd">    &gt;&gt;&gt; # Example 1: plotting the bland altman plot whilst incorporating a hue column</span>
<span class="sd">    &gt;&gt;&gt; fig, ax, means, diffs = bland_altman_plot(data=df, column1=&quot;m1&quot;, column2=&quot;m2&quot;, hue_column=&quot;hue_column&quot;, sd_limit=1.96,</span>
<span class="sd">    ...                                              scatter_kwds=None, mean_line_kwds=None, limit_lines_kwds=None,</span>
<span class="sd">    ...                                              plt_title=&quot;Bland Altman plot of \n two different measures&quot;,</span>
<span class="sd">    ...                                              figsize=(7,5))</span>
<span class="sd">    &gt;&gt;&gt; _ = plt.show()</span>
<span class="sd">    &gt;&gt;&gt; # Example 2: plotting the bland altman plot whilst incorporating specific keywords for the scatter plot</span>
<span class="sd">    &gt;&gt;&gt; fig, ax, means, diffs = bland_altman_plot(data=df, column1=&quot;m1&quot;, column2=&quot;m2&quot;,  hue_column=None,</span>
<span class="sd">    ...                                           sd_limit=1.96, scatter_kwds={&#39;color&#39;:&#39;navy&#39;},</span>
<span class="sd">    ...                                           mean_line_kwds=None, limit_lines_kwds=None,</span>
<span class="sd">    ...                                           plt_title=&quot;Bland Altman plot of \n two different measures&quot;,</span>
<span class="sd">    ...                                           figsize=(7,5))</span>
<span class="sd">    &gt;&gt;&gt; _ = plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data is not a valid pd.DataFrame object.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">sample_size_num</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">sample_size_col</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span>
            <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The amount of data in the columns is not equal across columns, hence the amount of data&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; shown in the plot is equal to </span><span class="si">{</span><span class="n">sample_size_num</span><span class="si">}</span><span class="s2">, column == </span><span class="si">{</span><span class="n">sample_size_col</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There is missing data in the columns, hence the amount of data&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; shown in the plot is equal to </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">sd_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sd_limit (</span><span class="si">{</span><span class="n">sd_limit</span><span class="si">}</span><span class="s2">) is less than 0.&quot;</span><span class="p">)</span>

    <span class="n">means</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">column2</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">column1</span><span class="p">]</span>
    <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span>
    <span class="n">std_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diffs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scatter_kwds</span><span class="p">:</span>
        <span class="n">scatter_kwds</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="k">for</span> <span class="n">kwds</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mean_line_kwds</span><span class="p">,</span> <span class="n">limit_lines_kwds</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;linewidth&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="s2">&quot;linestyle&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mean_line_kwds</span><span class="p">:</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;linestyle&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limit_lines_kwds</span><span class="p">:</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hue_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">diffs</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">hue_column</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_kwds</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">hue_column</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">diffs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_kwds</span><span class="p">)</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mean_diff</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_line_kwds</span><span class="p">)</span>  <span class="c1"># draw mean line.</span>

    <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Annotate mean line with mean difference.</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;mean</span><span class="se">\n</span><span class="s2">difference:</span><span class="se">\n</span><span class="si">{</span><span class="n">mean_diff</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.975</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">sd_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">half_ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">sd_limit</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_diff</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mean_diff</span> <span class="o">-</span> <span class="n">half_ylim</span><span class="p">,</span> <span class="n">mean_diff</span> <span class="o">+</span> <span class="n">half_ylim</span><span class="p">)</span>
        <span class="n">limit_of_agreement</span> <span class="o">=</span> <span class="n">sd_limit</span> <span class="o">*</span> <span class="n">std_diff</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">mean_diff</span> <span class="o">-</span> <span class="n">limit_of_agreement</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">mean_diff</span> <span class="o">+</span> <span class="n">limit_of_agreement</span>

        <span class="k">for</span> <span class="n">sign</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">]):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="o">**</span><span class="n">limit_lines_kwds</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sign</span><span class="si">}</span><span class="s2">SD(</span><span class="si">{</span><span class="n">sd_limit</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">lim</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.975</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">half_ylim</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">std_diff</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mean_diff</span> <span class="o">-</span> <span class="n">half_ylim</span><span class="p">,</span> <span class="n">mean_diff</span> <span class="o">+</span> <span class="n">half_ylim</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plt_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Bland Altman plot of two timepoints&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plt_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Difference&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Means&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">diffs</span></div>


<div class="viewcode-block" id="bland_altman_plot_repeated"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.bland_altman_plot_repeated">[docs]</a><span class="k">def</span> <span class="nf">bland_altman_plot_repeated</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">column1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">column2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">group_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hue_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limits_approach</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;anova&quot;</span><span class="p">,</span>
    <span class="n">aggregate_scatter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">aggregate_scatter_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">sd_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.96</span><span class="p">,</span>
    <span class="n">optional_formula</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scatter_kwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">mean_line_kwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">limit_lines_kwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">plt_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a Bland-Altman Mean Difference Plot.</span>
<span class="sd">    The Bland-Altman Plot is a graphical method to analyze</span>
<span class="sd">    the differences between two methods of measurement.</span>
<span class="sd">    It is a way of quantifying the agreement of two clinical measures.</span>
<span class="sd">    The mean of the measures is plotted against their difference.</span>
<span class="sd">    For more information see</span>
<span class="sd">    https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4470095/</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pd.DataFrame</span>
<span class="sd">        The data frame from which data will be used for the plot.</span>
<span class="sd">    column1: str</span>
<span class="sd">        The name of the column of the first measure.</span>
<span class="sd">    column2: str</span>
<span class="sd">        The name of the column of the second measure.</span>
<span class="sd">    hue_column: str</span>
<span class="sd">        The name of the column used to color groups in the Bland Altman Plot.</span>
<span class="sd">    sd_limit: float</span>
<span class="sd">        The limit of agreements expressed in terms of the standard deviation of</span>
<span class="sd">        the differences. If `md` is the mean of the differences, and `sd` is</span>
<span class="sd">        the standard deviation of those differences, then the limits of</span>
<span class="sd">        agreement that will be plotted are md +/- sd_limit * sd.</span>
<span class="sd">        The default of 1.96 will produce 95% confidence intervals for the means</span>
<span class="sd">        of the differences. If sd_limit = 0, no limits will be plotted, and</span>
<span class="sd">        the ylimit of the plot defaults to 3 standard deviations on either</span>
<span class="sd">        side of the mean.</span>
<span class="sd">    scatter_kwds: dict</span>
<span class="sd">        Options to to style the scatter plot. Accepts any keywords for the</span>
<span class="sd">        matplotlib Axes.scatter plotting method.</span>
<span class="sd">    mean_line_kwds: dict</span>
<span class="sd">        Options to to style the scatter plot. Accepts any keywords for the</span>
<span class="sd">        matplotlib Axes.axhline plotting method.</span>
<span class="sd">    limit_lines_kwds: dict</span>
<span class="sd">        Options to style the scatter plot. Accepts any keywords for the</span>
<span class="sd">        matplotlib Axes.axhline plotting method.</span>
<span class="sd">    plt_title: str</span>
<span class="sd">        An optional string to overwrite the default title.</span>
<span class="sd">    figsize: tuple</span>
<span class="sd">        A tuple of numbers to be passed to the plt.figure(figsize= ) function</span>
<span class="sd">        to manually specify the size of the plot.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: matplotlib.figure.Figure</span>
<span class="sd">        The matplotlib.figure.Figure object that is shown when running the function</span>
<span class="sd">    ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">        The associated matplotlib.axes._subplots.AxesSubplot object of the plotted figure</span>
<span class="sd">    means: pd.Series</span>
<span class="sd">        The series of means that are plotted</span>
<span class="sd">    diffs: pd.Series</span>
<span class="sd">        The series of differences that are plotted</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Bland JM, Altman DG (1986). &quot;Statistical methods for assessing agreement</span>
<span class="sd">    between two methods of clinical measurement&quot;</span>
<span class="sd">    Giavarina D. (2015). Understanding Bland Altman analysis. Biochemia medica, 25(2), 141–151. https://doi.org/10.11613/BM.2015.015</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Load relevant libraries.</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.frequentist_statistics import bland_altman_plot</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; # Making a bland-altman difference plot.</span>
<span class="sd">    &gt;&gt;&gt; # Seed the random number generator.</span>
<span class="sd">    &gt;&gt;&gt; # This ensures that the results below are reproducible.</span>
<span class="sd">    &gt;&gt;&gt; np.random.seed(69420)</span>
<span class="sd">    &gt;&gt;&gt; measure_1 = np.random.random(100)</span>
<span class="sd">    &gt;&gt;&gt; measure_2 = np.random.random(100)</span>
<span class="sd">    &gt;&gt;&gt; other_group_difference = np.random.choice([0, 1], 100)</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&quot;m1&quot;: measure_1, &quot;m2&quot;: measure_2, &quot;hue_column&quot;: other_group_difference})</span>
<span class="sd">    &gt;&gt;&gt; # Example 1: plotting the bland altman plot whilst incorporating a hue column</span>
<span class="sd">    &gt;&gt;&gt; fig, ax, means, diffs = bland_altman_plot(data=df, column1=&quot;m1&quot;, column2=&quot;m2&quot;, hue_column=&quot;hue_column&quot;, sd_limit=1.96,</span>
<span class="sd">    ...                                              scatter_kwds=None, mean_line_kwds=None, limit_lines_kwds=None,</span>
<span class="sd">    ...                                              plt_title=&quot;Bland Altman plot of \n two different measures&quot;,</span>
<span class="sd">    ...                                              figsize=(7,5))</span>
<span class="sd">    &gt;&gt;&gt; _ = plt.show()</span>
<span class="sd">    &gt;&gt;&gt; # Example 2: plotting the bland altman plot whilst incorporating specific keywords for the scatter plot</span>
<span class="sd">    &gt;&gt;&gt; fig, ax, means, diffs = bland_altman_plot(data=df, column1=&quot;m1&quot;, column2=&quot;m2&quot;,  hue_column=None,</span>
<span class="sd">    ...                                           sd_limit=1.96, scatter_kwds={&#39;color&#39;:&#39;navy&#39;},</span>
<span class="sd">    ...                                           mean_line_kwds=None, limit_lines_kwds=None,</span>
<span class="sd">    ...                                           plt_title=&quot;Bland Altman plot of \n two different measures&quot;,</span>
<span class="sd">    ...                                           figsize=(7,5))</span>
<span class="sd">    &gt;&gt;&gt; _ = plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data is not a valid pd.DataFrame object.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">sample_size_num</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">sample_size_col</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span>
            <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The amount of data in the columns is not equal across columns, hence the amount of data&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; shown in the plot is equal to </span><span class="si">{</span><span class="n">sample_size_num</span><span class="si">}</span><span class="s2">, column == </span><span class="si">{</span><span class="n">sample_size_col</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There is missing data in the columns, hence the amount of data&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; shown in the plot is equal to </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">sd_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sd_limit (</span><span class="si">{</span><span class="n">sd_limit</span><span class="si">}</span><span class="s2">) is less than 0.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Currently the group_column has not been specified, for this function to work this is required.&quot;</span>
        <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[[</span><span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;differences&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">column2</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">column1</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;differences&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scatter_kwds</span><span class="p">:</span>
        <span class="n">scatter_kwds</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="k">for</span> <span class="n">kwds</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mean_line_kwds</span><span class="p">,</span> <span class="n">limit_lines_kwds</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;linewidth&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="s2">&quot;linestyle&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mean_line_kwds</span><span class="p">:</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;linestyle&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limit_lines_kwds</span><span class="p">:</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hue_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">aggregate_scatter</span><span class="p">:</span>
            <span class="n">aggregated_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_column</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregate_scatter_method</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">aggregated_data</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">aggregated_data</span><span class="p">[</span><span class="s2">&quot;differences&quot;</span><span class="p">],</span>
                <span class="n">hue</span><span class="o">=</span><span class="n">aggregated_data</span><span class="p">[</span><span class="n">hue_column</span><span class="p">],</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="o">**</span><span class="n">scatter_kwds</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">hue_column</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;differences&quot;</span><span class="p">],</span>
                <span class="n">hue</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">hue_column</span><span class="p">],</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="o">**</span><span class="n">scatter_kwds</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">hue_column</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">aggregate_scatter</span><span class="p">:</span>
            <span class="n">aggregated_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_column</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregate_scatter_method</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">aggregated_data</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">aggregated_data</span><span class="p">[</span><span class="s2">&quot;differences&quot;</span><span class="p">],</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="o">**</span><span class="n">scatter_kwds</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;differences&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_kwds</span>
            <span class="p">)</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mean_diff</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_line_kwds</span><span class="p">)</span>  <span class="c1"># draw mean line.</span>

    <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Annotate mean line with mean difference.</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;mean</span><span class="se">\n</span><span class="s2">difference:</span><span class="se">\n</span><span class="si">{</span><span class="n">mean_diff</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.975</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">limits_approach</span> <span class="o">==</span> <span class="s2">&quot;anova&quot;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;differences~</span><span class="si">{</span><span class="n">group_column</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="c1"># Number of observations</span>
        <span class="n">obs_per_group_column</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">group_column</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">value_to_divide_by</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">obs_per_group_column</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">obs_per_group_column</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_per_group_column</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">obs_per_group_column</span><span class="p">))</span>

        <span class="c1"># (difference) Mean square residuals</span>
        <span class="n">anova_lm_results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">residual_mean_square</span> <span class="o">=</span> <span class="n">anova_lm_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_sq&quot;</span><span class="p">]</span>
        <span class="n">diff_mean_square</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">anova_lm_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_column</span><span class="p">,</span> <span class="s2">&quot;mean_sq&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">residual_mean_square</span>
        <span class="p">)</span>

        <span class="c1"># SD</span>
        <span class="n">estimated_component_variance</span> <span class="o">=</span> <span class="n">diff_mean_square</span> <span class="o">/</span> <span class="n">value_to_divide_by</span>
        <span class="n">sd_total_var_single_differences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">residual_mean_square</span> <span class="o">+</span> <span class="n">estimated_component_variance</span>
        <span class="p">)</span>

        <span class="n">lower</span> <span class="o">=</span> <span class="n">mean_diff</span> <span class="o">-</span> <span class="n">sd_limit</span> <span class="o">*</span> <span class="n">sd_total_var_single_differences</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">mean_diff</span> <span class="o">+</span> <span class="n">sd_limit</span> <span class="o">*</span> <span class="n">sd_total_var_single_differences</span>

    <span class="c1"># LMM approach to get limits</span>
    <span class="k">elif</span> <span class="n">limits_approach</span> <span class="o">==</span> <span class="s2">&quot;lmm&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">optional_formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span><span class="s2">&quot;differences~1&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">group_column</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span><span class="n">optional_formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># with contextlib.redirect_stdout(None):</span>
        <span class="c1"># _ = model.fit()</span>
        <span class="c1"># fixed_eff_df = model.summary()</span>
        <span class="c1"># mean_diff = fixed_eff_df.loc[&quot;(Intercept)&quot;, &quot;Estimate&quot;]</span>
        <span class="c1"># var_user_id = model.ranef_var[&quot;Std&quot;][group_column]</span>
        <span class="c1"># var_residuals = model.ranef_var[&quot;Std&quot;][&quot;Residual&quot;]</span>
        <span class="c1"># sd_total_var = np.sqrt(var_user_id + var_residuals)</span>
        <span class="c1"># lower=mean_diff - sd_limit*sd_total_var</span>
        <span class="c1"># upper=mean_diff + sd_limit*sd_total_var</span>

        <span class="n">mdf</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="n">var_user_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># in the pymer4 variant this is the standard deviation of the residuals associated with the random effects specifically.</span>
        <span class="c1"># statsmodels does not return this value so currently the standard deviation of the residuals of the whole model is used.</span>
        <span class="c1"># TODO: Look into how to get this different standard deviation if we have time in the future.</span>
        <span class="c1"># The previous implementation has been outcommented but not deleted in order to allow us to return to it easily.</span>
        <span class="n">var_residuals</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mdf</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># the naming is a tad confusing but the original implementation came from a df containing residual variances and standard deviations.</span>
        <span class="n">sd_total_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_user_id</span> <span class="o">+</span> <span class="n">var_residuals</span><span class="p">)</span>
        <span class="c1">## The difference in output between this implementation and the previous is that in this version the upper</span>
        <span class="c1">## and lower bounds are more strict.</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_diff</span> <span class="o">-</span> <span class="n">sd_limit</span> <span class="o">*</span> <span class="n">sd_total_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_diff</span> <span class="o">+</span> <span class="n">sd_limit</span> <span class="o">*</span> <span class="n">sd_total_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">sign</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">]):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="o">**</span><span class="n">limit_lines_kwds</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sign</span><span class="si">}</span><span class="s2">SD(</span><span class="si">{</span><span class="n">sd_limit</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">lim</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.975</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">plt_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Bland Altman Mean Difference plot for Repeated Measures using </span><span class="si">{</span><span class="n">limits_approach</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plt_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Difference&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Means&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;differences&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="ICC_repeated_measures_anova"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.ICC_repeated_measures_anova">[docs]</a><span class="k">def</span> <span class="nf">ICC_repeated_measures_anova</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the intraclass correlation (ICC) between 2 or more time points. The repeated measures ANOVA framework is</span>
<span class="sd">    used here with the equation:</span>

<span class="sd">    One Sample Repeated measure ANOVA:</span>
<span class="sd">    Y = XB + E with X = [Factor / Subjects]</span>

<span class="sd">    Along with the intraclass correlation, the degrees of freedom and the error terms used in the calculation, are</span>
<span class="sd">    also returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: Union[pd.DataFrame, np.array]</span>
<span class="sd">        The data frame or numpy array from which data will be used to calculate the ICC. The function expects the data</span>
<span class="sd">        in the form of rows=users, columns=time_points. i.e for 100 users and 2 time points where the measure is</span>
<span class="sd">        recorded, the shape should be (100, 2).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ICC: float</span>
<span class="sd">        The intraclass correlation between the different time points of the measure included in the data.</span>
<span class="sd">    between_subjects_variance: float</span>
<span class="sd">        The variance calculated between the mean square of the subject effect, the mean square of the error divided by</span>
<span class="sd">        the number of conditions.</span>
<span class="sd">    mean_square_error: float</span>
<span class="sd">        The mean of the squared error term.</span>
<span class="sd">    session_effect_F: float</span>
<span class="sd">        The f-statistic of the session effect - the variation between sample means divided by the</span>
<span class="sd">        variation within the samples</span>
<span class="sd">    degrees_freedom_conditions: float</span>
<span class="sd">        The degrees of freedom of the conditions i.e. the number of columns - 1.</span>
<span class="sd">    degrees_freedom_error: float</span>
<span class="sd">        The degrees of freedom of the error term i.e. the number of subjects or rows - 1 multiplied by the</span>
<span class="sd">         degrees of freedom of the conditions.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Shrout, P. E., &amp; Fleiss, J. L. (1979). Intraclass correlations: uses in assessing rater reliability.</span>
<span class="sd">    Psychological bulletin, 86(2), 420.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Load relevant libraries.</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.frequentist_statistics import ICC_repeated_measures_anova</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; # Calculating the ICC based on two time points.</span>
<span class="sd">    &gt;&gt;&gt; # Seed the random number generator.</span>
<span class="sd">    &gt;&gt;&gt; # This ensures that the results below are reproducible.</span>
<span class="sd">    &gt;&gt;&gt; np.random.seed(69420)</span>
<span class="sd">    &gt;&gt;&gt; measure_1 = np.random.random(100)</span>
<span class="sd">    &gt;&gt;&gt; measure_2 = np.random.random(100)</span>
<span class="sd">    &gt;&gt;&gt; user_ids = np.repeat(range(2000, 2020), 5)</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&quot;t1&quot;: measure_1, &quot;t2&quot;: measure_2, &quot;user_id&quot;: user_ids})</span>
<span class="sd">    &gt;&gt;&gt; (ICC, between_subjects_variance, mean_square_error, session_effect_F, degrees_freedom_conditions,</span>
<span class="sd">    ... degrees_freedom_error) = ICC_repeated_measures_anova(data=df[[&quot;t1&quot;, &quot;t2&quot;]])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supplied data frame has 0 rows.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The supplied data frame doesn&#39;t have sufficient columns. Please make sure the data frame supplied has&quot;</span>
            <span class="s2">&quot;at least two columns.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There is missing data in the columns, hence the amount of data&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; used to calculate the ICC is equal to </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="p">[</span><span class="n">number_subjects</span><span class="p">,</span> <span class="n">number_conditions</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">degrees_freedom_conditions</span> <span class="o">=</span> <span class="n">number_conditions</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">degrees_freedom_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">number_subjects</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">degrees_freedom_conditions</span>
    <span class="n">degrees_freedom_subjects</span> <span class="o">=</span> <span class="n">number_subjects</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Sum Square Total</span>
    <span class="n">mean_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">sum_square_total</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean_data</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># create the design matrix for the different levels</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">number_conditions</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">number_subjects</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>  <span class="c1"># sessions</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">number_subjects</span><span class="p">),</span> <span class="p">(</span><span class="n">number_conditions</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># subjects</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>

    <span class="c1"># Sum Square Error</span>
    <span class="n">predicted_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np_linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">))),</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">predicted_Y</span>
    <span class="n">sum_square_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">residuals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">mean_square_error</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sum_square_error</span> <span class="o">/</span> <span class="n">degrees_freedom_error</span>
    <span class="p">)</span>  <span class="c1"># also known as variance of error</span>

    <span class="c1"># Sum square session effect - between columns/ sessions</span>
    <span class="n">sum_square_session_effect</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean_data</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">number_subjects</span>
    <span class="n">mean_square_session_effect</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sum_square_session_effect</span> <span class="o">/</span> <span class="n">degrees_freedom_conditions</span> <span class="o">/</span> <span class="n">number_subjects</span>
    <span class="p">)</span>

    <span class="n">session_effect_F</span> <span class="o">=</span> <span class="n">mean_square_session_effect</span> <span class="o">/</span> <span class="n">mean_square_error</span>

    <span class="c1"># Sum Square subject effect - between rows/ subjects</span>
    <span class="n">sum_square_subject_effect</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sum_square_total</span> <span class="o">-</span> <span class="n">sum_square_session_effect</span> <span class="o">-</span> <span class="n">sum_square_error</span>
    <span class="p">)</span>
    <span class="n">mean_square_subject_effect</span> <span class="o">=</span> <span class="n">sum_square_subject_effect</span> <span class="o">/</span> <span class="n">degrees_freedom_subjects</span>

    <span class="n">ICC</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_square_subject_effect</span> <span class="o">-</span> <span class="n">mean_square_error</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">mean_square_subject_effect</span> <span class="o">+</span> <span class="n">degrees_freedom_conditions</span> <span class="o">*</span> <span class="n">mean_square_error</span>
    <span class="p">)</span>

    <span class="n">between_subjects_variance</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mean_square_subject_effect</span> <span class="o">-</span> <span class="n">mean_square_error</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">number_conditions</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">ICC</span><span class="p">,</span>
        <span class="n">between_subjects_variance</span><span class="p">,</span>
        <span class="n">mean_square_error</span><span class="p">,</span>
        <span class="n">session_effect_F</span><span class="p">,</span>
        <span class="n">degrees_freedom_conditions</span><span class="p">,</span>
        <span class="n">degrees_freedom_error</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="multiple_ICCs"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.multiple_ICCs">[docs]</a><span class="k">def</span> <span class="nf">multiple_ICCs</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">feature_list_of_dicts</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a data frame including the feature name, Intra-Class Correlation (ICC), Smallest Detectable Change (SDC),</span>
<span class="sd">    Standard Error of Measurement (SEMc) between 2 or more time points. This function is essentially a wrapper function</span>
<span class="sd">    around the ICC_repeated_measures_anova() function in order to apply the function to multiple features.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: Union[pd.DataFrame, np.array]</span>
<span class="sd">        The data frame or numpy array from which data will be used to calculate the ICC. The function expects the data</span>
<span class="sd">        in the form of rows=users, columns=time_points. i.e for 100 users and 2 time points where the measure is</span>
<span class="sd">        recorded, the shape should be (100, 2).</span>
<span class="sd">    feature_list_of_dicts: list</span>
<span class="sd">        A list of dictionaries in the form of: [{&#39;general_name_1&#39;: [&#39;name_first_session&#39;, &#39;name_second_session&#39;]},</span>
<span class="sd">        {&#39;general_name_2&#39;: [&#39;name_width_first_session&#39;, &#39;name_second_session&#39;]}]. The &quot;general_name&quot; is the one shown</span>
<span class="sd">        in the returned data frame, and the list of other names are used to select the columns prior to the creation</span>
<span class="sd">        of the data frames used directly in the ICC_repeated_measures_anova() function for loop.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    all_ICC_based_measures_df: pd.DataFrame</span>
<span class="sd">        The intraclass correlation between the different time points of the measure included in the data.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Shrout, P. E., &amp; Fleiss, J. L. (1979). Intraclass correlations: uses in assessing rater reliability.</span>
<span class="sd">    Psychological bulletin, 86(2), 420.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Load relevant libraries.</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.frequentist_statistics import multiple_ICCs</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; df = sns.load_dataset(&quot;iris&quot;)</span>
<span class="sd">    &gt;&gt;&gt; df[&quot;pre_post&quot;] = np.concatenate((np.repeat(1, 75), np.repeat(2, 75)), axis=0)</span>
<span class="sd">    &gt;&gt;&gt; features_list = df.columns.tolist()[:-2]</span>
<span class="sd">    &gt;&gt;&gt; icc_df = pd.merge(df[df[&quot;pre_post&quot;]==1].reset_index(drop=True), df[df[&quot;pre_post&quot;]==2].reset_index(drop=True),</span>
<span class="sd">    ...                   how=&quot;left&quot;, left_index=True, right_index=True, suffixes=(&#39;_first_session&#39;, &#39;_second_session&#39;))</span>
<span class="sd">    &gt;&gt;&gt; feature_list_of_dicts = [{x: icc_df.filter(regex=x).columns.tolist()} for x in features_list]</span>
<span class="sd">    &gt;&gt;&gt; all_ICC_based_measures_df=multiple_ICCs(data=icc_df, feature_list_of_dicts=feature_list_of_dicts)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supplied data frame has 0 rows.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># check data is a valid pandas data frame</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data is not a valid pd.DataFrame object.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_list_of_dicts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># check that the feature list of dictionaries is a valid list</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;feature_list_of_dicts is not a valid list object.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_list_of_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># check that the first entry in the feature list of dictionaries is a valid dict</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;the first object in the feature_list_of_dicts is not a valid dict object.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">feature_list_of_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># check that the key of the first entry in the feature list of dictionaries is a valid string</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;the key of the first object in the feature_list_of_dicts is not a valid string.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">feature_list_of_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># check that the value of the first entry in the feature list of dictionaries is a valid list</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;the value of the first object in the feature_list_of_dicts is not a valid list object.&quot;</span>
        <span class="p">)</span>

    <span class="n">list_of_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">feature_list_of_dicts</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_lengths</span><span class="p">):</span>
        <span class="c1"># check that the length of all the column lists in the feature_list_of_dicts is at least 2.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;there is a list of feature names columns that is less than two, please make sure all&quot;</span>
            <span class="s2">&quot;lists of column names in the feature_list_of_dicts have at least two in them.&quot;</span>
        <span class="p">)</span>

    <span class="n">list_of_icc_columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">feature_list_of_dicts</span><span class="p">]</span>
    <span class="n">flat_list_of_icc_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">list_of_icc_columns</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">flat_list_of_icc_columns</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
        <span class="c1"># check that the columns specified in the as values in the feature_list_of_dicts are in the columns</span>
        <span class="c1"># of the data provided.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;There are features in the lists of column names in the feature_list_of_dicts that are not present in the&quot;</span>
            <span class="s2">&quot;columns of the provided data.&quot;</span>
        <span class="p">)</span>

    <span class="n">all_ICC_based_measures_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">feature_dict</span> <span class="ow">in</span> <span class="n">feature_list_of_dicts</span><span class="p">:</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">feature_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">icc_feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">feature_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_4_ICC</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">icc_feature_names</span><span class="p">]</span>
        <span class="p">(</span>
            <span class="n">ICC</span><span class="p">,</span>
            <span class="n">between_subjects_variance</span><span class="p">,</span>
            <span class="n">mean_square_error</span><span class="p">,</span>
            <span class="n">session_effect_F</span><span class="p">,</span>
            <span class="n">degrees_freedom_conditions</span><span class="p">,</span>
            <span class="n">degrees_freedom_error</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">ICC_repeated_measures_anova</span><span class="p">(</span><span class="n">df_4_ICC</span><span class="p">)</span>
        <span class="n">SEMc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_square_error</span><span class="p">)</span>
        <span class="n">SDC</span> <span class="o">=</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">SEMc</span>

        <span class="n">current_ICC_based_measures_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">feature</span><span class="p">],</span>
                <span class="s2">&quot;ICC&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">ICC</span><span class="p">,</span> <span class="mi">4</span><span class="p">)],</span>
                <span class="s2">&quot;SEMc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">SEMc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)],</span>
                <span class="s2">&quot;SDC&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">SDC</span><span class="p">,</span> <span class="mi">4</span><span class="p">)],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">all_ICC_based_measures_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">all_ICC_based_measures_df</span><span class="p">,</span> <span class="n">current_ICC_based_measures_df</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">all_ICC_based_measures_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="c1"># flake8: noqa: C901, F722</span>
<div class="viewcode-block" id="diagnostic_plots"><a class="viewcode-back" href="../../usage.html#neuropy.frequentist_statistics.diagnostic_plots">[docs]</a><span class="k">def</span> <span class="nf">diagnostic_plots</span><span class="p">(</span>
    <span class="n">model_fit</span><span class="p">:</span> <span class="s2">&quot;fitted linear model&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="n">limit_cooks_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">subplot_adjust_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">},</span>
<span class="p">):</span>

    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;This function is an extension of the diagnostic_plots function. This is done to include the use of models</span>
<span class="sd">    defined using pymer4, statsmodels, and sklearn*. Specifically the currently accepted models are:</span>

<span class="sd">    - pymer4.models.Lm.Lm</span>
<span class="sd">    - pymer4.models.Lmer.Lmer</span>
<span class="sd">    - sklearn.linear_model._base.LinearRegression</span>
<span class="sd">    - sklearn.linear_model._coordinate_descent.Lasso</span>
<span class="sd">    - sklearn.linear_model._ridge.Ridge</span>
<span class="sd">    - statsmodels.regression.linear_model.RegressionResultsWrapper</span>
<span class="sd">    - statsmodels.regression.mixed_linear_model.MixedLMResultsWrapper</span>

<span class="sd">    *The sklearn models listed have been tried, although in theory all variants of the sklearn linear regression</span>
<span class="sd">     models should work with this function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_fit:</span>
<span class="sd">        A fitted linear regression model, ideally one of the ones listed above.</span>
<span class="sd">    X:</span>
<span class="sd">        The array of predictors used to fit the model. This is only required if the inputted model is an sklearn</span>
<span class="sd">        model. For all other models just the fitted model is sufficient.</span>
<span class="sd">    y:</span>
<span class="sd">        The target array used to fit the model. This is only required if the inputted model is an sklearn</span>
<span class="sd">        model. For all other models just the fitted model is sufficient.</span>
<span class="sd">    figsize: tuple</span>
<span class="sd">        Width and height of the figure in inches</span>
<span class="sd">    limit_cooks_plot: bool</span>
<span class="sd">        Whether to apply a y-limit to the cooks distances plot (i.e. would you like to see the cooks distances</span>
<span class="sd">        better, or the individual scatter points better?)</span>
<span class="sd">    subplot_adjust_args: dict</span>
<span class="sd">        A dictionary of arguments to change the dimensions of the subplots. This is useful to include if the chosen</span>
<span class="sd">        figsize is making the plot labels overlap.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    diagplot: matplotlib.figure.Figure</span>
<span class="sd">        Figure with four diagnostic plots: residuals vs fitted, QQplot, scale location, residuals vs leverage</span>
<span class="sd">    axes: np.array</span>
<span class="sd">        An array of the associated axes of the four subplots.</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; ## Pymer4 example</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; from pymer4 import Lmer</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.frequentist_statistics import diagnostic_plots</span>
<span class="sd">    &gt;&gt;&gt; data = sns.load_dataset(name=&quot;mpg&quot;)</span>
<span class="sd">    &gt;&gt;&gt; model_fit = Lmer(&quot;mpg ~ cylinders + displacement + weight + acceleration + (1 | model_year)&quot;, data=data)</span>
<span class="sd">    &gt;&gt;&gt; model_summary = model_fit.fit(conf_int = &quot;profile&quot;)</span>
<span class="sd">    &gt;&gt;&gt; fig, axs = diagnostic_plots(model_fit=model_fit,</span>
<span class="sd">    ...                                         X=None,</span>
<span class="sd">    ...                                         y=None,</span>
<span class="sd">    ...                                         figsize = (8,8),</span>
<span class="sd">    ...                                         limit_cooks_plot = False,</span>
<span class="sd">    ...                                         subplot_adjust_args={&quot;wspace&quot;: 0.3, &quot;hspace&quot;: 0.3}</span>
<span class="sd">    ...                                        )</span>
<span class="sd">    &gt;&gt;&gt; ## sklearn example</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; from sklearn.linear_model import LinearRegression</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.frequentist_statistics import diagnostic_plots</span>
<span class="sd">    &gt;&gt;&gt; data = sns.load_dataset(name=&quot;mpg&quot;)</span>
<span class="sd">    &gt;&gt;&gt; X = data[[&#39;cylinders&#39;, &#39;displacement&#39;, &#39;weight&#39;, &#39;acceleration&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; y = data[&quot;mpg&quot;]</span>
<span class="sd">    &gt;&gt;&gt; model_fit = LinearRegression().fit(X, y)</span>
<span class="sd">    &gt;&gt;&gt; fig, axs = diagnostic_plots(model_fit=model_fit,</span>
<span class="sd">    ...                                         X=X,</span>
<span class="sd">    ...                                         y=y,</span>
<span class="sd">    ...                                         figsize = (8,8),</span>
<span class="sd">    ...                                         limit_cooks_plot = False,</span>
<span class="sd">    ...                                         subplot_adjust_args={&quot;wspace&quot;: 0.3, &quot;hspace&quot;: 0.3}</span>
<span class="sd">    ...                                        )</span>
<span class="sd">    &gt;&gt;&gt; ## statsmodels example</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; import statsmodels.api as sm</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.frequentist_statistics import diagnostic_plots</span>
<span class="sd">    &gt;&gt;&gt; data = sns.load_dataset(name=&quot;mpg&quot;)</span>
<span class="sd">    &gt;&gt;&gt; X = data[[&#39;cylinders&#39;, &#39;displacement&#39;, &#39;weight&#39;, &#39;acceleration&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; y = data[&quot;mpg&quot;]</span>
<span class="sd">    &gt;&gt;&gt; model_fit = sm.MixedLM(endog=y, exog=X, groups=data[&quot;model_year&quot;]).fit(method=[&quot;lbfgs&quot;])</span>
<span class="sd">    &gt;&gt;&gt; fig, axs = diagnostic_plots(model_fit=model_fit,</span>
<span class="sd">    ...                                         X=None,</span>
<span class="sd">    ...                                         y=None,</span>
<span class="sd">    ...                                         figsize = (8,8),</span>
<span class="sd">    ...                                         limit_cooks_plot = False,</span>
<span class="sd">    ...                                         subplot_adjust_args={&quot;wspace&quot;: 0.3, &quot;hspace&quot;: 0.3}</span>
<span class="sd">    ...                                        )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_model_fit</span><span class="p">(</span><span class="n">model_fit</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model_fit</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">substring</span> <span class="ow">in</span> <span class="n">source</span> <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pymer4&quot;</span><span class="p">,</span> <span class="s2">&quot;sklearn&quot;</span><span class="p">,</span> <span class="s2">&quot;statsmodels&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The model </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">, is currently not supported by this function.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;pymer4&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">model_fitted_y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">fits</span><span class="p">)</span>
            <span class="n">model_residuals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">residuals</span><span class="p">)</span>
            <span class="n">model_norm_residuals</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">residuals</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">residuals</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="n">model_abs_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_residuals</span><span class="p">)</span>
            <span class="n">model_norm_residuals_abs_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;sklearn&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">substring</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DataFrame&quot;</span><span class="p">,</span> <span class="s2">&quot;Series&quot;</span><span class="p">,</span> <span class="s2">&quot;ndarray&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The fitted model specified was an sklearn model which requires X to not be None and one of</span>
<span class="s2">                    either a pandas DataFrame or Series, or a numpy ndarray. The X supplied was of type: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">substring</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Series&quot;</span><span class="p">,</span> <span class="s2">&quot;ndarray&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The fitted model specified was an sklearn model which requires y to not be None and one of</span>
<span class="s2">                    either a pandas Series, or a numpy ndarray. The y supplied was of type: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
                <span class="p">)</span>

            <span class="n">model_fitted_y</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">model_residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">model_norm_residuals</span> <span class="o">=</span> <span class="n">model_residuals</span> <span class="o">/</span> <span class="n">model_residuals</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

            <span class="n">model_abs_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_residuals</span><span class="p">)</span>
            <span class="n">model_norm_residuals_abs_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;statsmodels&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="c1"># model values</span>
            <span class="n">model_fitted_y</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">fittedvalues</span>
            <span class="c1"># model residuals</span>
            <span class="n">model_residuals</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">resid</span>
            <span class="c1"># absolute residuals</span>
            <span class="n">model_abs_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_residuals</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;regression.mixed_linear_model&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="c1"># studentized residuals</span>
                <span class="n">model_norm_residuals</span> <span class="o">=</span> <span class="n">model_residuals</span> <span class="o">/</span> <span class="n">model_residuals</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                <span class="c1"># absolute square root residuals</span>
                <span class="n">model_norm_residuals_abs_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">))</span>

            <span class="k">if</span> <span class="s2">&quot;regression.linear_model&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="c1"># normalized residuals</span>
                <span class="n">model_norm_residuals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">model_fit</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">resid_studentized_internal</span>
                <span class="p">)</span>
                <span class="n">model_norm_residuals</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>
                <span class="n">model_norm_residuals</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;model_norm_residuals&quot;</span>

                <span class="c1"># root square absolute normalized residuals</span>
                <span class="n">model_norm_residuals_abs_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">model_fitted_y</span><span class="p">,</span>
            <span class="n">model_residuals</span><span class="p">,</span>
            <span class="n">model_norm_residuals</span><span class="p">,</span>
            <span class="n">model_abs_resid</span><span class="p">,</span>
            <span class="n">model_norm_residuals_abs_sqrt</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_model_leverage</span><span class="p">(</span><span class="n">model_fit</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model_fit</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;statsmodels.regression.linear&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="c1"># leverage, from statsmodels internals</span>
            <span class="n">model_leverage</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">model_fit</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span><span class="o">.</span><span class="n">hat_matrix_diag</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;pymer4&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Lm.&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="s2">&quot;Lmer&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="s2">&quot;sklearn&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="s2">&quot;statsmodels&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="c1"># get the data used to predict the y (i.e. X or the exogenous variables)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog</span>

            <span class="n">hat_temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">hat_temp_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">hat_temp</span><span class="p">)</span>
            <span class="n">model_leverage</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">hat_temp_diag</span><span class="p">)</span>

        <span class="n">model_leverage</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;model_leverage&quot;</span>
        <span class="n">model_leverage</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>

        <span class="k">return</span> <span class="n">model_leverage</span>

    <span class="k">def</span> <span class="nf">_get_num_of_parameters</span><span class="p">(</span><span class="n">model_fit</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model_fit</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;pymer4&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Lm.&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">number_of_parameters</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;Lmer&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">ranef</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">number_of_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">fixef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">ranef</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">number_of_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="n">model_fit</span><span class="o">.</span><span class="n">ranef</span><span class="o">.</span><span class="n">columns</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;sklearn&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">number_of_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;statsmodels&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">number_of_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_fit</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">number_of_parameters</span>

    <span class="p">(</span>
        <span class="n">model_fitted_y</span><span class="p">,</span>
        <span class="n">model_residuals</span><span class="p">,</span>
        <span class="n">model_norm_residuals</span><span class="p">,</span>
        <span class="n">model_abs_resid</span><span class="p">,</span>
        <span class="n">model_norm_residuals_abs_sqrt</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_get_model_fit</span><span class="p">(</span><span class="n">model_fit</span><span class="p">)</span>
    <span class="n">model_leverage</span> <span class="o">=</span> <span class="n">_get_model_leverage</span><span class="p">(</span><span class="n">model_fit</span><span class="p">)</span>
    <span class="n">number_of_parameters</span> <span class="o">=</span> <span class="n">_get_num_of_parameters</span><span class="p">(</span><span class="n">model_fit</span><span class="p">)</span>

    <span class="c1">## PLOTTING STUFF</span>

    <span class="c1"># create figure with 4 subplots</span>
    <span class="n">diagplot</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="c1">#     _ = plt.subplots_adjust(wspace=0.6, hspace=0.6)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="o">**</span><span class="n">subplot_adjust_args</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Model diagnostics&quot;</span><span class="p">)</span>
    <span class="c1"># First plot: Residuals vs fitted</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">model_fitted_y</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">model_residuals</span><span class="p">,</span>
        <span class="n">scatter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">NeurocastColors</span><span class="o">.</span><span class="n">ORANGE</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
        <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">},</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">model_fitted_y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">model_fitted_y</span><span class="p">),</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_range</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">)),</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">NeurocastColors</span><span class="o">.</span><span class="n">MEDIUMGREY</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residuals vs Fitted&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Fitted values&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residuals&quot;</span><span class="p">)</span>
    <span class="n">margin_res</span> <span class="o">=</span> <span class="mf">0.10</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">model_residuals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">model_residuals</span><span class="p">))</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
        <span class="nb">min</span><span class="p">(</span><span class="n">model_residuals</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin_res</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">model_residuals</span><span class="p">)</span> <span class="o">+</span> <span class="n">margin_res</span>
    <span class="p">)</span>

    <span class="c1"># annotations: top 3 absolute residuals</span>
    <span class="n">abs_resid_top_3</span> <span class="o">=</span> <span class="n">model_abs_resid</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">abs_resid_top_3</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">model_fitted_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">model_residuals</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ordered_theoretical_quantiles</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ordered_residuals</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r_value</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">ordered_theoretical_quantiles</span><span class="p">,</span> <span class="n">ordered_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ordered_theoretical_quantiles</span><span class="p">,</span>
        <span class="n">slope</span> <span class="o">*</span> <span class="n">ordered_theoretical_quantiles</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">,</span>
        <span class="n">NeurocastColors</span><span class="o">.</span><span class="n">ORANGE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$R^2=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>

    <span class="c1"># _ = diagplot.axes[1].get_lines()[1].set_markerfacecolor(NeurocastColors.ORANGE)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Normal Q-Q&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Theoretical Quantiles&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Standardized Residuals&quot;</span><span class="p">)</span>

    <span class="n">abs_norm_resid_top_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">norm_resid_top_3</span> <span class="o">=</span> <span class="n">model_norm_residuals</span><span class="p">[</span><span class="n">abs_norm_resid_top_3</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">ordered_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;ordered_residuals&quot;</span><span class="p">:</span> <span class="n">ordered_residuals</span><span class="p">,</span>
            <span class="s2">&quot;ordered_theoretical_quantiles&quot;</span><span class="p">:</span> <span class="n">ordered_theoretical_quantiles</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">abs_norm_resid_top_3</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="c1">#         index = np.where(pd.Series(ordered_residuals).index == i)[0][0]</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span>
                <span class="n">ordered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">ordered_df</span><span class="p">[</span><span class="s2">&quot;ordered_residuals&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">norm_resid_top_3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s2">&quot;ordered_theoretical_quantiles&quot;</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">ordered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">ordered_df</span><span class="p">[</span><span class="s2">&quot;ordered_residuals&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">norm_resid_top_3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s2">&quot;ordered_residuals&quot;</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Third plot: scale location</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">model_fitted_y</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">model_norm_residuals_abs_sqrt</span><span class="p">,</span>
        <span class="n">scatter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">NeurocastColors</span><span class="o">.</span><span class="n">ORANGE</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
        <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">},</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Scale-Location&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Fitted values&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sqrt{|Standardized Residuals|}$&quot;</span><span class="p">)</span>
    <span class="c1"># annotations: top 3 absolute normalized residuals</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">abs_norm_resid_top_3</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">model_fitted_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">model_norm_residuals_abs_sqrt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="c1"># Fourth plot: residuals vs leverages</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">model_leverage</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">model_norm_residuals</span><span class="p">,</span>
        <span class="n">scatter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">NeurocastColors</span><span class="o">.</span><span class="n">ORANGE</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
        <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">},</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">model_leverage</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">limit_cooks_plot</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residuals vs Leverage&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Leverage&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Standardized Residuals&quot;</span><span class="p">)</span>

    <span class="c1"># annotations: top 3 levarages</span>
    <span class="n">leverage_top_3</span> <span class="o">=</span> <span class="n">model_leverage</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leverage_top_3</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">model_leverage</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">model_norm_residuals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="c1"># extra lines to indicate Cook&#39;s distances</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">model_leverage</span><span class="p">),</span> <span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cooksdistances</span><span class="p">(</span><span class="n">boundary</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">boundary</span> <span class="o">*</span> <span class="n">number_of_parameters</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">l_formula</span> <span class="o">=</span> <span class="n">cooksdistances</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">cooks_line</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x_range</span><span class="p">,</span>
                <span class="n">place</span> <span class="o">*</span> <span class="n">l_formula</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">NeurocastColors</span><span class="o">.</span><span class="n">ORANGE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">y_text</span> <span class="o">=</span> <span class="n">place</span> <span class="o">*</span> <span class="n">l_formula</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">model_leverage</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
                <span class="o">&lt;</span> <span class="n">y_text</span>
                <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">model_norm_residuals</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="p">):</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">model_leverage</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                    <span class="n">y_text</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">NeurocastColors</span><span class="o">.</span><span class="n">ORANGE</span><span class="p">,</span>
                <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">diagplot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">cooks_line</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Cook&#39;s distance&quot;</span><span class="p">],</span> <span class="n">handlelength</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">diagplot</span><span class="p">,</span> <span class="n">axes</span></div>
</pre></div>

    </div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>

        <br/>


    </p>
    <p>
        &copy; Copyright 2022, Neurocast Data Science Team.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>
