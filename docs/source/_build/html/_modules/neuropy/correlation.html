<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>neuropy.correlation &#8212; neuropy v1.5.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">

                <li><a href="../../index.html">Home</a></li>


              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html"><code class="docutils literal notranslate"><span class="pre">neuropy.anomaly_detection</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.cluster_analysis"><code class="docutils literal notranslate"><span class="pre">neuropy.cluster_analysis</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.config"><code class="docutils literal notranslate"><span class="pre">neuropy.config</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.correlation"><code class="docutils literal notranslate"><span class="pre">neuropy.correlation</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.dimensionality_reduction"><code class="docutils literal notranslate"><span class="pre">neuropy.dimensionality_reduction</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.frequency_domain"><code class="docutils literal notranslate"><span class="pre">neuropy.frequency_domain</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.frequentist_statistics"><code class="docutils literal notranslate"><span class="pre">neuropy.frequentist_statistics</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.group_analysis"><code class="docutils literal notranslate"><span class="pre">neuropy.group_analysis</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.internal_composite"><code class="docutils literal notranslate"><span class="pre">neuropy.internal_composite</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.internal_utils"><code class="docutils literal notranslate"><span class="pre">neuropy.internal_utils</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.machine_learning_classification"><code class="docutils literal notranslate"><span class="pre">neuropy.machine_learning_classification</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.machine_learning_regression"><code class="docutils literal notranslate"><span class="pre">neuropy.machine_learning_regression</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.machine_learning_utils"><code class="docutils literal notranslate"><span class="pre">neuropy.machine_learning_utils</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.utils"><code class="docutils literal notranslate"><span class="pre">neuropy.utils</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#module-neuropy.vumc_utils"><code class="docutils literal notranslate"><span class="pre">neuropy.vumc_utils</span></code></a></li>
</ul>
</ul>
</li>

                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>






          </ul>



<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">

  <h1>Source code for neuropy.correlation</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Submodule correlation.py includes the following functions: &lt;br&gt;</span>
<span class="sd">   - **correlation_analysis():** Run correlations for numerical features and return output in different formats &lt;br&gt;</span>
<span class="sd">   - **plot_correlogram():** Plot correlogram of numerical features. Rows with missing values are excluded &lt;br&gt;</span>
<span class="sd">   - **ancovan():** An internal function compiled from the necessary parts of the pingouin.ancova() function &lt;br&gt;</span>
<span class="sd">   - **rm_correlation_analysis():** Run a repeated measures correlation &lt;br&gt;</span>
<span class="sd">   - **correlations_as_sample_increases():** Run correlations for subparts of the data to check robustness &lt;br&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">statsmodels.api</span> <span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">statsmod_stats</span>
<span class="kn">from</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">import</span> <span class="n">ols</span>

<span class="kn">from</span> <span class="nn">neuropy.frequentist_statistics</span> <span class="kn">import</span> <span class="n">normal_check</span>
<span class="kn">from</span> <span class="nn">neuropy.frequentist_statistics</span> <span class="kn">import</span> <span class="n">permutation_plot</span>
<span class="kn">from</span> <span class="nn">neuropy.frequentist_statistics</span> <span class="kn">import</span> <span class="n">permute_test</span>


<div class="viewcode-block" id="correlation_analysis"><a class="viewcode-back" href="../../usage.html#neuropy.correlation.correlation_analysis">[docs]</a><span class="k">def</span> <span class="nf">correlation_analysis</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">col_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">row_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">check_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pearson&quot;</span><span class="p">,</span>
    <span class="n">dropna</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pairwise&quot;</span><span class="p">,</span>
    <span class="n">permutation_test</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_permutations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_permutation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">11.7</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run correlations for numerical features and return output in different formats</span>

<span class="sd">    Different methods to compute correlations and to handle missing values are implemented.</span>
<span class="sd">    Inspired by `researchpy.corr_case` and `researchpy.corr_pair`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        Dataframe with variables in columns, cases in rows</span>
<span class="sd">    row_list: list or None (default: None)</span>
<span class="sd">        List with names of columns in `data` that should be in the rows of the correlogram.</span>
<span class="sd">        If None, all columns are used but only every unique combination.</span>
<span class="sd">    col_list: list or None (default: None)</span>
<span class="sd">        List with names of columns in `data` that should be in the columns of the correlogram.</span>
<span class="sd">        If None, all columns are used and only every unique combination.</span>
<span class="sd">    check_norm: bool (default: False)</span>
<span class="sd">        If True, normality will be checked for columns in `data` using `normal_check`. This influences the used method</span>
<span class="sd">        for correlations, i.e. Pearson or Spearman. Note: normality check ignores missing values.</span>
<span class="sd">    method: {&#39;pearson&#39;, &#39;kendall&#39;, &#39;spearman&#39;}, default &#39;pearson&#39;</span>
<span class="sd">        Type of correlation, either Pearson&#39;s r, Spearman&#39;s rho, or Kendall&#39;s tau, implemented via respectively</span>
<span class="sd">        `scipy.stats.pearsonr`, `scipy.stats.spearmanr`, and `scipy.stats.kendalltau`</span>
<span class="sd">        Will be ignored if check_norm=True. Instead, Person&#39;s r is used for every combination of normally distributed</span>
<span class="sd">        columns and Spearman&#39;s rho is used for all other combinations.</span>
<span class="sd">    dropna : {&#39;listwise&#39;, &#39;pairwise&#39;}, default &#39;pairwise&#39;</span>
<span class="sd">        Should rows with missing values be dropped over the complete `data` (&#39;listwise&#39;) or for every correlation</span>
<span class="sd">        separately (&#39;pairwise&#39;)</span>
<span class="sd">    permutation_test: bool (default: False)</span>
<span class="sd">        If true, a permutation test will added</span>
<span class="sd">    n_permutations: int (default: 1000)</span>
<span class="sd">        Number of permutations in the permutation test</span>
<span class="sd">    random_state: None or int (default: None)</span>
<span class="sd">        Random state for permutation_test. If not None, random_state will be updated for every permutation</span>
<span class="sd">    plot_permutation: bool (default: False)</span>
<span class="sd">        Whether to plot the results of the permutation test</span>
<span class="sd">    figsize: tuple (default: (11.7, 8.27))</span>
<span class="sd">        Width and height of the figure in inches</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    result_dict: dict</span>
<span class="sd">        Dictionary containing with the following keys:</span>
<span class="sd">        info : pandas.DataFrame</span>
<span class="sd">            Description of correlation method, missing values handling and number of observations</span>
<span class="sd">        r-values : pandas.DataFrame</span>
<span class="sd">            Dataframe with correlation coefficients. Indices and columns are column names from `data`. Only lower</span>
<span class="sd">            triangle is filled.</span>
<span class="sd">        p-values : pandas.DataFrame</span>
<span class="sd">            Dataframe with p-values. Indices and columns are column names from `data`. Only lower triangle is filled.</span>
<span class="sd">        N        : pandas.DataFrame</span>
<span class="sd">            Dataframe with numbers of observations. Indices and columns are column names from `data`. Only lower</span>
<span class="sd">            triangle is filled. If dropna =&#39;listwise&#39;, every correlation will have the same number of observations.</span>
<span class="sd">        summary : pandas.DataFrame</span>
<span class="sd">            Dataframe with columns [&#39;analysis&#39;, &#39;feature1&#39;, &#39;feature2&#39;, &#39;r-value&#39;, &#39;p-value&#39;, &#39;N&#39;, &#39;stat-sign&#39;]</span>
<span class="sd">            which indicate the type of test used for the correlation, the pair of columns, the correlation coefficient,</span>
<span class="sd">            the p-value, the number of observations for each combination of columns in `data` and whether the r-value is</span>
<span class="sd">            statistically significant.</span>
<span class="sd">    plotted_permuations: Figure</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.correlation import correlation_analysis</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; iris = sns.load_dataset(&#39;iris&#39;)</span>
<span class="sd">    &gt;&gt;&gt; dict_results, fig_permutations = correlation_analysis(iris, method=&#39;pearson&#39;, dropna=&#39;listwise&#39;, permutation_test=True,</span>
<span class="sd">    &gt;&gt;&gt;                                        n_permutations=100, check_norm=True)</span>
<span class="sd">    &gt;&gt;&gt; dict_results[&#39;summary&#39;]</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Bryant, C (2018). researchpy&#39;s documentation [Revision 9ae5ed63]. Retrieved from</span>
<span class="sd">    https://researchpy.readthedocs.io/en/latest/</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Settings test</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pearson&quot;</span><span class="p">:</span>
        <span class="n">test</span><span class="p">,</span> <span class="n">test_name</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">,</span> <span class="s2">&quot;Pearson&quot;</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;spearman&quot;</span><span class="p">:</span>
        <span class="n">test</span><span class="p">,</span> <span class="n">test_name</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">,</span> <span class="s2">&quot;Spearman Rank&quot;</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;kendall&quot;</span><span class="p">:</span>
        <span class="n">test</span><span class="p">,</span> <span class="n">test_name</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kendalltau</span><span class="p">,</span> <span class="s2">&quot;Kendall&#39;s Tau-b&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method not in {&#39;pearson&#39;, &#39;kendall&#39;, &#39;spearman&#39;}&quot;</span><span class="p">)</span>

    <span class="c1"># Copy numerical data from the original data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
    <span class="n">plotted_permutations</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get correct lists</span>
    <span class="k">if</span> <span class="n">col_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row_list</span><span class="p">:</span>
        <span class="n">row_list</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">row_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col_list</span><span class="p">:</span>
        <span class="n">col_list</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">row_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Initializing dataframes to store results</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">col_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row_list</span><span class="p">:</span>
        <span class="n">r_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">p_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">n_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_list</span><span class="p">)</span>
        <span class="n">p_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_list</span><span class="p">)</span>
        <span class="n">n_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_list</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">col_list</span><span class="p">,</span> <span class="n">row_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dropna</span> <span class="o">==</span> <span class="s2">&quot;listwise&quot;</span><span class="p">:</span>
        <span class="c1"># Remove rows with missing values</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s2"> correlation test using </span><span class="si">{</span><span class="n">dropna</span><span class="si">}</span><span class="s2"> deletion&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Total observations used = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">},</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">dropna</span> <span class="o">==</span> <span class="s2">&quot;pairwise&quot;</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s2"> correlation test using </span><span class="si">{</span><span class="n">dropna</span><span class="si">}</span><span class="s2"> deletion&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Observations in the data = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">},</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dropna not in {&#39;listwise&#39;, &#39;pairwise&#39;}&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">check_norm</span><span class="p">:</span>
        <span class="c1"># Check normality of all columns in the data</span>
        <span class="n">df_normality</span> <span class="o">=</span> <span class="n">normal_check</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">norm_names</span> <span class="o">=</span> <span class="n">df_normality</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_normality</span><span class="p">[</span><span class="s2">&quot;normality&quot;</span><span class="p">],</span> <span class="s2">&quot;feature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">permutation_test</span><span class="p">)</span> <span class="ow">and</span> <span class="n">plot_permutation</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Asked for plots but permutation=False so no permutation plot will be added&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Iterating through the Pandas series and performing the correlation</span>
    <span class="k">for</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dropna</span> <span class="o">==</span> <span class="s2">&quot;pairwise&quot;</span><span class="p">:</span>
            <span class="c1"># Remove rows with missing values in the pair of columns</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">check_norm</span><span class="p">:</span>
            <span class="c1"># Select Pearson&#39;s r only if both columns are normally distributed</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">col1</span> <span class="ow">in</span> <span class="n">norm_names</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">col2</span> <span class="ow">in</span> <span class="n">norm_names</span><span class="p">):</span>
                <span class="n">test</span><span class="p">,</span> <span class="n">test_name</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">,</span> <span class="s2">&quot;Pearson&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test</span><span class="p">,</span> <span class="n">test_name</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">,</span> <span class="s2">&quot;Spearman Rank&quot;</span>

        <span class="c1"># Run correlations</span>
        <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col1</span><span class="p">],</span> <span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col2</span><span class="p">])</span>
        <span class="n">n_value</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="c1"># Store output in matrix format</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_value</span>
            <span class="n">p_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_value</span>
            <span class="n">n_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_value</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">r_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_value</span>
            <span class="n">p_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_value</span>
            <span class="n">n_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_value</span>

        <span class="c1"># Store output in dataframe format</span>
        <span class="n">dict_summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">test_name</span><span class="p">,</span>
            <span class="s2">&quot;feature1&quot;</span><span class="p">:</span> <span class="n">col1</span><span class="p">,</span>
            <span class="s2">&quot;feature2&quot;</span><span class="p">:</span> <span class="n">col2</span><span class="p">,</span>
            <span class="s2">&quot;r-value&quot;</span><span class="p">:</span> <span class="n">r_value</span><span class="p">,</span>
            <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">n_value</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">permutation_test</span><span class="p">:</span>
            <span class="c1"># Copy the complete data</span>
            <span class="n">col2_shuffle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col2</span><span class="p">])</span>
            <span class="n">col2_shuffle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">col2_shuffle</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">n_permutations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># Shuffle within the columns</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
            <span class="n">ix_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">col2_shuffle</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ix_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">col2_shuffle</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">col2_shuffle</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">col2_shuffle</span> <span class="o">=</span> <span class="n">col2_shuffle</span><span class="p">[</span><span class="n">ix_i</span><span class="p">,</span> <span class="n">ix_j</span><span class="p">]</span>
            <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
                <span class="n">permute_test</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">arr</span><span class="o">=</span><span class="n">col2_shuffle</span><span class="p">,</span>
                <span class="n">test_type</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
                <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
                <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col1</span><span class="p">]),</span>
            <span class="p">)</span>

            <span class="n">extreme_permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">permutations</span> <span class="o">&lt;</span> <span class="n">p_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p_permutation</span> <span class="o">=</span> <span class="n">extreme_permutation</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span>
            <span class="n">dict_summary</span><span class="p">[</span><span class="s2">&quot;permutation-p-value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_permutation</span>

            <span class="k">if</span> <span class="n">plot_permutation</span><span class="p">:</span>
                <span class="n">plotted_permutations</span> <span class="o">=</span> <span class="n">permutation_plot</span><span class="p">(</span>
                    <span class="n">permutations</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">feature1</span><span class="o">=</span><span class="n">col1</span><span class="p">,</span> <span class="n">feature2</span><span class="o">=</span><span class="n">col2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
                <span class="p">)</span>

            <span class="c1"># Reset random seed numpy</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">summary</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_summary</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Embed results within a dictionary</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;r-value&quot;</span><span class="p">:</span> <span class="n">r_vals</span><span class="p">,</span>
        <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_vals</span><span class="p">,</span>
        <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">n_vals</span><span class="p">,</span>
        <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">info</span><span class="p">,</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result_dict</span><span class="p">,</span> <span class="n">plotted_permutations</span></div>


<div class="viewcode-block" id="plot_correlogram"><a class="viewcode-back" href="../../usage.html#neuropy.correlation.plot_correlogram">[docs]</a><span class="k">def</span> <span class="nf">plot_correlogram</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">row_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">col_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">check_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">,</span>
    <span class="n">dropna</span><span class="o">=</span><span class="s2">&quot;pairwise&quot;</span><span class="p">,</span>
    <span class="n">margins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">show_p</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">diverging_palette</span><span class="p">(</span><span class="n">h_neg</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">h_pos</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot correlogram of numerical features. Rows with missing values are excluded.</span>
<span class="sd">    Different methods to compute correlations are implemented.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        Dataframe with variables in columns, cases in rows</span>
<span class="sd">    row_list: list or None (default: None)</span>
<span class="sd">        List with names of columns in `data` that should be in the rows of the correlogram.</span>
<span class="sd">        If None, all columns are used and only the lower half of the correlogram will be filled.</span>
<span class="sd">    col_list: list or None (default: None)</span>
<span class="sd">        List with names of columns in `data` that should be in the columns of the correlogram.</span>
<span class="sd">        If None, all columns are used and only the lower half of the correlogram will be filled.</span>
<span class="sd">    check_norm: bool (default: False)</span>
<span class="sd">        If True, normality will be checked for columns in `data` using `normal_check`. This influences the used method</span>
<span class="sd">        for correlations, `method` will be ignored. Note: normality check ignores missing values.</span>
<span class="sd">    method: {&#39;pearson&#39;, &#39;kendall&#39;, &#39;spearman&#39;}, default &#39;pearson&#39;</span>
<span class="sd">        Type of correlation, either Pearson&#39;s r, Spearman&#39;s rho, or Kendall&#39;s tau, implemented via respectively</span>
<span class="sd">        `scipy.stats.pearsonr`, `scipy.stats.spearmanr`, and `scipy.stats.kendalltau`. Ignored if check_norm is True.</span>
<span class="sd">    dropna : {&#39;listwise&#39;, &#39;pairwise&#39;}, default &#39;pairwise&#39;</span>
<span class="sd">        Should rows with missing values be dropped over the complete `data` (&#39;listwise&#39;) or for every correlation</span>
<span class="sd">        separately (&#39;pairwise&#39;)</span>
<span class="sd">    margins: dict or &#39;jupyter&#39; or None (default: None)</span>
<span class="sd">        Margins for the correlogram. Any of them that are None are referred from `matplotlib.pyplot.subplots_adjust`</span>
<span class="sd">        If &#39;jupyter&#39;, default values are {&#39;left&#39;: None, &#39;bottom&#39;: 1, &#39;right&#39;: None, &#39;top&#39;: 2}.</span>
<span class="sd">    font_scale: float</span>
<span class="sd">        Size of the labels in the correlogram.</span>
<span class="sd">    show_p: bool (default: True)</span>
<span class="sd">        Place crosses when correlation is not significant (i.e. p-value higher than 0.05).</span>
<span class="sd">    cmap: colormap (either seaborn or matplotlib)</span>
<span class="sd">        A continuous colormap either from seaborn or matplotlib which will be used to define the extremes in the</span>
<span class="sd">        correlogram. For more information see: https://seaborn.pydata.org/tutorial/color_palettes.html</span>
<span class="sd">    figsize: tuple (default: (15, 15))</span>
<span class="sd">        Width and height of the figure in inches.</span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    corplot: Figure</span>
<span class="sd">        Graph with `seaborn.heatmap` of the correlations (lower triangle only)</span>
<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; iris = sns.load_dataset(&#39;iris&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = plot_correlogram(iris, method=&#39;pearson&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute correlation matrix</span>
    <span class="n">dict_results</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">correlation_analysis</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">col_list</span><span class="o">=</span><span class="n">col_list</span><span class="p">,</span>
        <span class="n">row_list</span><span class="o">=</span><span class="n">row_list</span><span class="p">,</span>
        <span class="n">check_norm</span><span class="o">=</span><span class="n">check_norm</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">dropna</span><span class="o">=</span><span class="n">dropna</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">dict_results</span><span class="p">[</span><span class="s2">&quot;r-value&quot;</span><span class="p">]</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">col_list</span> <span class="ow">or</span> <span class="n">row_list</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Generate a mask for the upper triangle</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>

    <span class="c1"># Add the mask to the heatmap</span>
    <span class="n">corplot</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
        <span class="n">corr</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.3f&quot;</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">show_p</span><span class="p">:</span>
        <span class="n">pvalues</span> <span class="o">=</span> <span class="n">dict_results</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># Set X where pvalues is bigger than 0.05</span>
        <span class="n">pvalues_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pvalues</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">col_list</span> <span class="ow">or</span> <span class="n">row_list</span><span class="p">:</span>
            <span class="c1"># Run over all elements of the array</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">pvalues</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Only take one half of the pvalues</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">pvalues</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">col_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row_list</span><span class="p">:</span>
                <span class="c1"># Reverse x and y to make sure the crosses are plotted at the right places</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">pvalues_str</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">font_scale</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">check_norm</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Correlation using Pearson and Spearman&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> correlation&quot;</span><span class="p">)</span>

    <span class="c1"># Move axis to make sure they align</span>
    <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">ymax</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">margins</span><span class="p">:</span>
        <span class="n">margins</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">margins</span> <span class="o">==</span> <span class="s2">&quot;jupyter&quot;</span><span class="p">:</span>
        <span class="n">margins</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="o">**</span><span class="n">margins</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">corplot</span></div>


<div class="viewcode-block" id="correlations_as_sample_increases"><a class="viewcode-back" href="../../usage.html#neuropy.correlation.correlations_as_sample_increases">[docs]</a><span class="k">def</span> <span class="nf">correlations_as_sample_increases</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">feature2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">starting_N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">bootstrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bootstrap_per_N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">addition_to_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot changes in r-value and p-value from correlation between two features when sample size increases.</span>

<span class="sd">    Different methods to compute correlations are implemented. Data is shuffled first, to prevent any order effects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        Dataframe with variables in columns, cases in rows</span>
<span class="sd">    feature1: str</span>
<span class="sd">        Name of column with first feature to be included in correlation</span>
<span class="sd">    feature2: str</span>
<span class="sd">        Name of column with second feature to be included in correlation</span>
<span class="sd">    starting_N: int (default: 10)</span>
<span class="sd">        Number of cases that should be used for first correlation</span>
<span class="sd">    step: int (default: 1)</span>
<span class="sd">        Step for increasing the number of cases for the correlations</span>
<span class="sd">    method: {&#39;pearson&#39;, &#39;kendall&#39;, &#39;spearman&#39;}, default &#39;pearson&#39;</span>
<span class="sd">        Type of correlation, either Pearson&#39;s r, Spearman&#39;s rho, or Kendall&#39;s tau, implemented via respectively</span>
<span class="sd">        `scipy.stats.pearsonr`, `scipy.stats.spearmanr`, and `scipy.stats.kendalltau`.</span>
<span class="sd">    random_state: int (default: 42)</span>
<span class="sd">        Random state for reordering the data</span>
<span class="sd">    bootstrap: bool</span>
<span class="sd">        Whether to bootstrap the data at each N</span>
<span class="sd">    bootstrap_per_N: int</span>
<span class="sd">        If bootstrap is True then how many bootstraps per each sample size should be performed i.e if bootstrap_per_N</span>
<span class="sd">        is 2 then at sample size N=20, 2 bootstraps will be performed. This will continue until starting_N == N.</span>
<span class="sd">    plot: bool (default: True)</span>
<span class="sd">        Whether to plot the results</span>
<span class="sd">    addition_to_title: str (default: &#39;&#39;)</span>
<span class="sd">        The title of the plot will be &quot;The absolute r-value between {feature1} and {feature2} as N increases&quot; and</span>
<span class="sd">        followed by the addition (e.g. to describe a dataset).</span>
<span class="sd">    alpha: float (default: 0.05)</span>
<span class="sd">        Threshold for p-value that should be shown in the plot</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    cor_results: pd.DataFrame</span>
<span class="sd">        Dataframe with the results for all ran analyses</span>
<span class="sd">    fig: Figure</span>
<span class="sd">        Figure will be returned if plot=True, otherwise None. This allows you to change properties of the figure</span>
<span class="sd">        afterwards, e.g. fig.axes[0].set_title(&#39;This is my new title&#39;)</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.correlation import correlations_as_sample_increases</span>
<span class="sd">    &gt;&gt;&gt; iris = sns.load_dataset(&#39;iris&#39;)</span>
<span class="sd">    &gt;&gt;&gt; summary,  fig = correlations_as_sample_increases(data=iris,feature1=&#39;petal_width&#39;,feature2=&#39;sepal_length&#39;,</span>
<span class="sd">    &gt;&gt;&gt; starting_N=20)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">data</span><span class="p">[[</span><span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Remove rows with np.nans</span>
        <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="c1"># Randomize order of the data</span>
        <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">starting_N</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of valid cases is smaller than the starting_N&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">starting_N</span> <span class="o">+</span> <span class="n">step</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Number of valid cases is smaller than the starting_N + step (only one correlation possible)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Initiate data frame for results</span>
    <span class="n">corr_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Loop through all possible number of rows from starting N till number of rows</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">starting_N</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="n">boot_corr_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bootstrap</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">boot_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bootstrap_per_N</span><span class="p">):</span>
                <span class="n">boot_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">boot_num</span><span class="p">)</span>
                <span class="n">current_boot_corr</span> <span class="o">=</span> <span class="n">correlation_analysis</span><span class="p">(</span>
                    <span class="n">boot_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">check_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">permutation_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">][[</span><span class="s2">&quot;r-value&quot;</span><span class="p">,</span> <span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">]]</span>
                <span class="n">boot_corr_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">boot_corr_results</span><span class="p">,</span> <span class="n">current_boot_corr</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="n">corr_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">corr_results</span><span class="p">,</span> <span class="n">boot_corr_results</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Run correlation with all data from first row until row i</span>
            <span class="n">current_corr</span> <span class="o">=</span> <span class="n">correlation_analysis</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">check_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">permutation_test</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">][[</span><span class="s2">&quot;r-value&quot;</span><span class="p">,</span> <span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">]]</span>
            <span class="n">corr_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">corr_results</span><span class="p">,</span> <span class="n">current_corr</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="c1"># Add r-value and p-value</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">corr_results</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">corr_results</span><span class="p">[</span><span class="s2">&quot;r-value&quot;</span><span class="p">]),</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;absolute r-value&quot;</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The absolute r-value between </span><span class="si">{</span><span class="n">feature1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">feature2</span><span class="si">}</span><span class="se">\n</span><span class="s2">as N increases </span><span class="si">{</span><span class="n">addition_to_title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">corr_results</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">corr_results</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
        <span class="p">)</span>
        <span class="c1"># Add alpha level (threshold for p-value)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&gt;= </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">corr_results</span><span class="p">,</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="ancovan"><a class="viewcode-back" href="../../usage.html#neuropy.correlation.ancovan">[docs]</a><span class="k">def</span> <span class="nf">ancovan</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">covar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">between</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">effsize</span><span class="o">=</span><span class="s2">&quot;np2&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ANCOVA with n covariates.</span>
<span class="sd">    This is an internal function. The main call to this function should be done</span>
<span class="sd">    by the :py:func:`neuropy.correlation.rm_correlation_analysis` function.</span>
<span class="sd">    ATTENTION: This function should not be called directly, please use the rm_correlation_analysis() function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check that covariates are numeric (&#39;float&#39;, &#39;int&#39;)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s2">&quot;fi&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">covar</span><span class="p">))])</span>

    <span class="c1"># Fit ANCOVA model</span>
    <span class="c1"># formula = dv + &#39; ~ C(&#39; + between + &#39;)&#39;</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;Q(&#39;</span><span class="si">%s</span><span class="s2">&#39;) ~ C(Q(&#39;</span><span class="si">%s</span><span class="s2">&#39;))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="n">between</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">covar</span><span class="p">:</span>
        <span class="n">formula</span> <span class="o">+=</span> <span class="s2">&quot; + Q(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">aov</span> <span class="o">=</span> <span class="n">statsmod_stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">aov</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Source&quot;</span><span class="p">,</span> <span class="s2">&quot;sum_sq&quot;</span><span class="p">:</span> <span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;PR(&gt;F)&quot;</span><span class="p">:</span> <span class="s2">&quot;p-unc&quot;</span><span class="p">},</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">aov</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">between</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">covar</span><span class="p">)):</span>
        <span class="n">aov</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">aov</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aov</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Add effect sizes</span>
    <span class="k">if</span> <span class="n">effsize</span> <span class="o">==</span> <span class="s2">&quot;n2&quot;</span><span class="p">:</span>
        <span class="n">all_effsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">aov</span><span class="p">[</span><span class="s2">&quot;SS&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">aov</span><span class="p">[</span><span class="s2">&quot;SS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">all_effsize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ss_resid</span> <span class="o">=</span> <span class="n">aov</span><span class="p">[</span><span class="s2">&quot;SS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">all_effsize</span> <span class="o">=</span> <span class="n">aov</span><span class="p">[</span><span class="s2">&quot;SS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ss_resid</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">all_effsize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">aov</span><span class="p">[</span><span class="n">effsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_effsize</span>
    <span class="k">return</span> <span class="n">aov</span></div>


<div class="viewcode-block" id="rm_correlation_analysis"><a class="viewcode-back" href="../../usage.html#neuropy.correlation.rm_correlation_analysis">[docs]</a><span class="k">def</span> <span class="nf">rm_correlation_analysis</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">target_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">subject_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span>
    <span class="n">dropna</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pairwise&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run a repeated measure correlation for numerical features and return output in different formats</span>

<span class="sd">    Repeated measures correlation (rmcorr) is a statistical technique for determining the common</span>
<span class="sd">    within-individual association for paired measures assessed on two or more occasions for multiple individuals.</span>
<span class="sd">    Inspired by `pinqoun.rm_corr`.</span>

<span class="sd">    Rmcorr can be viewed as a “light” version of multilevel modeling because it is comparable to a simple,</span>
<span class="sd">    null multilevel model with random/varying effects of intercept for each individual and a fixed effect</span>
<span class="sd">    (i.e., common/overall) slope. However, rmcorr only analyzes intra-individual variance. Multilevel modeling</span>
<span class="sd">     can simultaneously analyze both intra- and inter-individual variance using partial pooling, which permits</span>
<span class="sd">     varying slopes and other parameters that cannot be estimated with simpler techniques.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df: pandas.DataFrame</span>
<span class="sd">        Dataframe with variables in columns, cases in rows</span>
<span class="sd">    feature_list: list or None (default: None)</span>
<span class="sd">        List with names of columns in `df` that represent keystroke dynamic features.</span>
<span class="sd">        If None, all numerical columns are used but only every unique combination.</span>
<span class="sd">    target_list: list or None (default: None)</span>
<span class="sd">        List with names of columns in `df` that represent endpoints or clinical measures.</span>
<span class="sd">        If None, all columns are used and only every unique combination.</span>
<span class="sd">    subject_column: str (default: &#39;user_id&#39;)</span>
<span class="sd">        Name of column in `df` containing the subject indicator.</span>
<span class="sd">    dropna : {&#39;listwise&#39;, &#39;pairwise&#39;}, default &#39;pairwise&#39;</span>
<span class="sd">        Should rows with missing values be dropped over the complete `df` (&#39;listwise&#39;) or for every correlation</span>
<span class="sd">        separately (&#39;pairwise&#39;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result_dict: dict</span>
<span class="sd">        Dictionary containing with the following keys:</span>
<span class="sd">        info : pandas.DataFrame</span>
<span class="sd">            Description of correlation method, missing values handling and number of observations</span>
<span class="sd">        r-values : pandas.DataFrame</span>
<span class="sd">            Dataframe with rm correlation coefficients. Indices and columns are column names from `data`. Only lower</span>
<span class="sd">            triangle is filled.</span>
<span class="sd">        p-values : pandas.DataFrame</span>
<span class="sd">            Dataframe with p-values. Indices and columns are column names from `data`. Only lower triangle is filled.</span>
<span class="sd">        N        : pandas.DataFrame</span>
<span class="sd">            Dataframe with numbers of observations. Indices and columns are column names from `data`. Only lower</span>
<span class="sd">            triangle is filled. If dropna =&#39;listwise&#39;, every correlation will have the same number of observations.</span>
<span class="sd">        summary : pandas.DataFrame</span>
<span class="sd">            Dataframe with columns [&#39;analysis&#39;, &#39;feature1&#39;, &#39;feature2&#39;, &#39;r-value&#39;, &#39;p-value&#39;, &#39;N&#39;, &#39;stat-sign&#39;]</span>
<span class="sd">            which indicate the type of test used for the correlation, the pair of columns, the correlation coefficient,</span>
<span class="sd">            the p-value, the number of observations for each combination of columns in `data` and whether the r-value is</span>
<span class="sd">            statistically significant.</span>

<span class="sd">    Examples</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.correlation import rm_correlation_analysis</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; df = sns.load_dataset(&quot;mpg&quot;).dropna()</span>
<span class="sd">    &gt;&gt;&gt; df[&quot;origin&quot;] = df.origin.astype(&quot;category&quot;).cat.codes</span>
<span class="sd">    &gt;&gt;&gt; # convert the country of origin to integer as the rm_correlation functions expect all inputs to be numeric</span>
<span class="sd">    &gt;&gt;&gt; dict_results = rm_correlation_analysis(df=df, feature_list=[&#39;mpg&#39;], target_list=[&#39;horsepower&#39;], subject_column=&#39;origin&#39;)</span>
<span class="sd">    &gt;&gt;&gt; dict_results[&#39;summary&#39;]</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Bakdash, J.Z., Marusich, L.R., 2017. Repeated Measures Correlation. Front. Psychol. 8, 456.</span>
<span class="sd">    https://doi.org/10.3389/fpsyg.2017.00456</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initial checks</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_column</span><span class="p">])[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_column</span><span class="p">])[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Subjects with less then 3 samples were detected and removed. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Number of unique Subjects = </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">feature_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Nan values were found in the following columns:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;These will be removed using </span><span class="si">{</span><span class="n">dropna</span><span class="si">}</span><span class="s2"> dropping&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">feature_list</span> <span class="ow">and</span> <span class="n">target_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Nan values were found in the following columns:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;These will be removed using </span><span class="si">{</span><span class="n">dropna</span><span class="si">}</span><span class="s2"> dropping&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">target_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target_list</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Nan values were found in the following columns:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">target_list</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">target_list</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;These will be removed using </span><span class="si">{</span><span class="n">dropna</span><span class="si">}</span><span class="s2"> dropping&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Copy numerical data from the original data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>

    <span class="c1"># Get correct lists</span>
    <span class="k">if</span> <span class="n">target_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="n">feature_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">subject_column</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">feature_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">target_list</span><span class="p">:</span>
        <span class="n">target_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">feature_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">subject_column</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c1"># Initializing dataframes to store results</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="n">r_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">p_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">n_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_list</span><span class="p">)</span>
        <span class="n">p_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_list</span><span class="p">)</span>
        <span class="n">n_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_list</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">target_list</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">target_list</span> <span class="o">+</span> <span class="n">feature_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">subject_column</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">dropna</span> <span class="o">==</span> <span class="s2">&quot;listwise&quot;</span><span class="p">:</span>
        <span class="c1"># Remove rows with missing values</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;RM correlation test using </span><span class="si">{</span><span class="n">dropna</span><span class="si">}</span><span class="s2"> deletion&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Total observations used = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">},</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">dropna</span> <span class="o">==</span> <span class="s2">&quot;pairwise&quot;</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;RM correlation test using </span><span class="si">{</span><span class="n">dropna</span><span class="si">}</span><span class="s2"> deletion&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Observations in the data = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">},</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dropna not in {&#39;listwise&#39;, &#39;pairwise&#39;}&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dropna</span> <span class="o">==</span> <span class="s2">&quot;pairwise&quot;</span><span class="p">:</span>
            <span class="c1"># Remove rows with missing values in the pair of columns</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">subject_column</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">test_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_column</span><span class="p">])[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span>
                <span class="n">test_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_column</span><span class="p">])[</span><span class="n">subject_column</span><span class="p">]</span>
                <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Subjects with less then 3 samples were detected and removed. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Number of unique Subjects = </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">test_data</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">n_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;At least 3 unique subjects are required. This condition is not met after dropping NaN for:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_value</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

            <span class="c1"># compute the anova (bare in mind the covar expects the input as a list - this is taken direct from pingouin, might want to change it in the future)</span>
            <span class="n">aov</span> <span class="o">=</span> <span class="n">ancovan</span><span class="p">(</span><span class="n">dv</span><span class="o">=</span><span class="n">col1</span><span class="p">,</span> <span class="n">covar</span><span class="o">=</span><span class="p">[</span><span class="n">col2</span><span class="p">],</span> <span class="n">between</span><span class="o">=</span><span class="n">subject_column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">test_data</span><span class="p">)</span>

            <span class="c1"># Compute slopes</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">groups</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">groups</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="n">dt_covar</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="p">][</span><span class="n">col2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">dt_covar</span> <span class="o">-</span> <span class="n">dt_covar</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span>
                    <span class="n">dt_covar</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="p">][</span><span class="n">col1</span><span class="p">],</span> <span class="mi">1</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ss_slopes</span> <span class="o">=</span> <span class="n">ss</span> <span class="o">*</span> <span class="n">slopes</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">ss_slopes</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>  <span class="c1"># Beta within parameter</span>

            <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">bw</span><span class="p">)</span>
            <span class="n">ssfactor</span> <span class="o">=</span> <span class="n">aov</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;SS&quot;</span><span class="p">]</span>
            <span class="n">sserror</span> <span class="o">=</span> <span class="n">aov</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;SS&quot;</span><span class="p">]</span>
            <span class="n">r_value</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ssfactor</span> <span class="o">/</span> <span class="p">(</span><span class="n">ssfactor</span> <span class="o">+</span> <span class="n">sserror</span><span class="p">))</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">aov</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;p-unc&quot;</span><span class="p">]</span>

            <span class="c1"># Store output in matrix format</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_value</span>
                <span class="n">p_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_value</span>
                <span class="n">n_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_value</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">r_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_value</span>
                <span class="n">p_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_value</span>
                <span class="n">n_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_value</span>

        <span class="c1"># Store output in dataframe format</span>
        <span class="n">dict_summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;rm_corr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;feature1&quot;</span><span class="p">:</span> <span class="n">col1</span><span class="p">,</span>
            <span class="s2">&quot;feature2&quot;</span><span class="p">:</span> <span class="n">col2</span><span class="p">,</span>
            <span class="s2">&quot;r-value&quot;</span><span class="p">:</span> <span class="n">r_value</span><span class="p">,</span>
            <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s2">&quot;stat-sign&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">n_value</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">summary</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_summary</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Embed results within a dictionary</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;r-value&quot;</span><span class="p">:</span> <span class="n">r_vals</span><span class="p">,</span>
            <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p_vals</span><span class="p">,</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">n_vals</span><span class="p">,</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">info</span><span class="p">,</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">result_dict</span></div>


<div class="viewcode-block" id="plot_rm_correlation"><a class="viewcode-back" href="../../usage.html#neuropy.correlation.plot_rm_correlation">[docs]</a><span class="k">def</span> <span class="nf">plot_rm_correlation</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">subject_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span>
    <span class="n">legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">kwargs_facetgrid</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Paired&quot;</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df: pandas.DataFrame</span>
<span class="sd">        Dataframe with variables in columns, cases in rows</span>
<span class="sd">    feature, target : str</span>
<span class="sd">        Name of columns in `df` containing the two dependent variables.</span>
<span class="sd">    subject_column: str</span>
<span class="sd">        Name of column in `df` containing the subject indicator.</span>
<span class="sd">    legend : boolean (default=True)</span>
<span class="sd">        If True, add legend to plot. Legend will show all the unique values in</span>
<span class="sd">        ``subject``.</span>
<span class="sd">    kwargs_facetgrid : dict</span>
<span class="sd">        Optional keyword argument passed to :py:class:`seaborn.FacetGrid`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    g : :py:class:`seaborn.FacetGrid`</span>
<span class="sd">        Seaborn FacetGrid.</span>
<span class="sd">    test_data : :py:class:`pandas.DataFrame`</span>
<span class="sd">        A pandas DataFrame including the initial data with a predicted outcomes column appended.</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    rm_correlation_analysis</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Repeated measures correlation (rmcorr) is a statistical technique</span>
<span class="sd">    for determining the common within-individual association for paired</span>
<span class="sd">    measures assessed on two or more occasions for multiple individuals.</span>

<span class="sd">    Results have been tested against the `rmcorr` R package. Note that this</span>
<span class="sd">    function requires the statsmodels Python package.</span>

<span class="sd">    Missing values are automatically removed from the ``data``</span>
<span class="sd">    (listwise deletion).</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Bakdash, J.Z., Marusich, L.R., 2017. Repeated Measures Correlation.</span>
<span class="sd">           Front. Psychol. 8, 456. https://doi.org/10.3389/fpsyg.2017.00456</span>

<span class="sd">    .. [2] Bland, J. M., &amp; Altman, D. G. (1995). Statistics notes: Calculating</span>
<span class="sd">           correlation coefficients with repeated observations:</span>
<span class="sd">           Part 1—correlation within subjects. Bmj, 310(6977), 446.</span>

<span class="sd">    .. [3] https://github.com/cran/rmcorr</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from neuropy.correlation import plot_rm_correlation</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; df = sns.load_dataset(&quot;mpg&quot;).dropna()</span>
<span class="sd">    &gt;&gt;&gt; df[&quot;origin&quot;] = df.origin.astype(&quot;category&quot;).cat.codes</span>
<span class="sd">    &gt;&gt;&gt; # convert the country of origin to integer as the rm_correlation functions expect all inputs to be numeric</span>
<span class="sd">    &gt;&gt;&gt; _, rm_corr_df = plot_rm_correlation(df=df,</span>
<span class="sd">    &gt;&gt;&gt;                    feature=&#39;mpg&#39;,</span>
<span class="sd">    &gt;&gt;&gt;                    target=&#39;horsepower&#39;,</span>
<span class="sd">    &gt;&gt;&gt;                    subject_column=&#39;origin&#39;,</span>
<span class="sd">    &gt;&gt;&gt;                   kwargs_facetgrid={&#39;height&#39;: 4, &#39;aspect&#39;: 1.5, &#39;palette&#39;: &#39;Paired&#39;}</span>
<span class="sd">    &gt;&gt;&gt;                   )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initial checks</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_column</span><span class="p">])[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_column</span><span class="p">])[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Subjects with less then 3 samples were detected and removed. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Number of unique Subjects = </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least 3 unique subjects are required.&quot;</span><span class="p">)</span>

    <span class="c1"># Copy numerical data from the original data</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="n">target</span><span class="p">]]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input contains NaN.&quot;</span><span class="p">)</span>

    <span class="c1"># Fit ANCOVA model</span>
    <span class="c1"># https://patsy.readthedocs.io/en/latest/builtins-reference.html</span>
    <span class="c1"># C marks the data as categorical</span>
    <span class="c1"># Q allows to quote variable that do not meet Python variable name rule</span>
    <span class="c1"># e.g. if variable is &quot;weight.in.kg&quot; or &quot;2A&quot;</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;Q(&#39;</span><span class="si">%s</span><span class="s2">&#39;) ~ C(Q(&#39;</span><span class="si">%s</span><span class="s2">&#39;)) + Q(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">subject_column</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">test_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="c1"># Fitted values</span>
    <span class="n">test_data</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fittedvalues</span>

    <span class="c1"># Define color palette</span>
    <span class="k">if</span> <span class="s2">&quot;palette&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs_facetgrid</span><span class="p">:</span>
        <span class="n">kwargs_facetgrid</span><span class="p">[</span><span class="s2">&quot;palette&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">hls_palette</span><span class="p">(</span>
            <span class="n">test_data</span><span class="p">[</span><span class="n">subject_column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c1"># set limits for plotting</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.95</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.05</span>
    <span class="n">y_min</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.95</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.05</span>

    <span class="c1"># Start plot</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">subject_column</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_facetgrid</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">,</span>
        <span class="n">feature</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="n">subject_column</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="n">kwargs_facetgrid</span><span class="p">[</span><span class="s2">&quot;palette&quot;</span><span class="p">],</span>
        <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">))</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;RM Correlation - </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;fontweight&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_legend</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">test_data</span></div>
</pre></div>

    </div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>

        <br/>


    </p>
    <p>
        &copy; Copyright 2022, Neurocast Data Science Team.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>
